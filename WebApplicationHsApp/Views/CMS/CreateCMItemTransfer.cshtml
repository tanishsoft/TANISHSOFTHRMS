

<script>
    var eId = @ViewBag.id;
    var tbaleRowCount = 1;
    $(document).ready(function () {
        $('.error1').hide();
        $('#ItemTable').show();
            $(".date")
                .datepicker({
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: "dd/mm/yy",
                    Edit: true,
                    minDate: 0

                })
        LoadItems();
      

        EmployeeSearch();
        LoadStore();
          $(".EmpId").select2("trigger", "select", { data: { id: '@ViewBag.Userid', text: '@ViewBag.UserName' } });
        if (eId != 0) {
            LoadData(eId);
            LoadItemsDetails(eId);
        }
        else {
            AddItem();
        }
    });
    function LoadStore() {
        $.ajax({
            type: "POST",
            url: "/CMS/GetCMS_Store",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Store -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].StoreId + '">' + data[i].StoreName + '</option>');
                }
                $(".StoreId").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function LoadItems(id, val) {
        $.ajax({
            type: "POST",
            url: "/CMS/GetCMS_Items",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Item -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].ItemId + '">' + data[i].ItemName + '</option>');
                }
                $("#ItemId").html(options.join(''));
                $("#ItemId" + id).html(options.join(''));

                var table = document.getElementById("ItemTable");
                var table_len = (table.rows.length);
                for (var i = 1; i < tbaleRowCount; i++) {
                    var mealtype = $("#ItemId" + i).val();
                    if (mealtype != "")
                        $("#ItemId" + id + " option[value=" + mealtype + "]").remove();

                }
                var len = $("#ItemId" + id + " option").length;
                if (len == 1) {
                    delete_row(id);
                }
                if (val != "")
                    $("#ItemId" + id).val(val);
            },

            error: function () {
                alert("error")
            }
        });
    }

    function EmployeeSearch() {

        $(".EmpId").select2({
            ajax: {
                url: "/Home/GetEmployeeSearch",
                type: "get",
                dataType: 'json',

                //delay: 250,
                data: function (params) {
                    return {
                        searchTerm: params.term // search term
                    };
                },
                processResults: function (response) {
                    return {
                        results: response
                    };
                },
                cache: true
            },
            width: 'element',
            minimumInputLength: 4
        });
    }
    function LoadData(id) {
        $.get("/CMS/GetCMS_ItemTransfer_ById?id=" + id, function (res) {

            $("#FromStoreId").val(res.FromStoreId);
            $("#ToStoreId").val(res.ToStoreId);
            //$("#ModeOfTransfer").val(res.ModeOfTransfer);
            $("#RequestedEmpId").select2("trigger", "select", { data: { id: res.RequestedEmpId, text: res.RequestedEmpName } });
            $("#RequestedOn").val(res.RequestedOn);
            $("#RequestorNotes").val(res.RequestorNotes);
            //$("#FromLocationId").val(res.FromLocationId);
            //$("#ToLocationId").val(res.ToLocationId);
            //$('#IsCanteen').prop('checked', res.IsCanteen);
            $("#header").text("Update Item");
        });
    }
    function LoadItemsDetails(id) {
        $.get("/CMS/GetCMS_TransferItems_BytraId?id=" + id, function (res) {

            var table = document.getElementById("ItemTable");
            for (var i = 0; i < res.length; i++) {

                AddItem(res[i].ItemId);
                $("#QtyRequested" + (i + 1)).val(res[i].QtyRequested);
                $(".Id" + (i + 1)).text(res[i].Id) ;
                //$("#QtyRecived" + (i + 1)).val(res[i].QtyRecived);
                //$("#QtyReturn" + (i + 1)).val(res[i].QtyReturn);
                //$("#QtyDamage" + (i + 1)).val(res[i].res[i].QtyDamage);
                $("#Notes" + (i + 1)).val(res[i].Notes);
            }
        });
    }
    function validatedetails() {
        setTimeout(function () { $('.error1').fadeOut('fast'); }, 5000);
        var valid = true;
        $(".error").hide();
        $(".css-error").removeClass('css-error');
        //if (!inputvalidation('FromLocationId', 'Select From Location')) valid=false;
        //if (!inputvalidation('ToLocationId', 'Select To Location')) valid = false;
        if (!inputvalidation('FromStoreId', 'Select From Store')) valid = false;
        if (!inputvalidation('ToStoreId', 'Select To Store')) valid = false;
        //if (!inputvalidation('ModeOfTransfer', 'select ModeOfTransfer')) valid = false;
        if (!inputvalidation('RequestedOn', 'Select Requested Date')) valid = false;
        if ($('#RequestedEmpId').val() == null) {
            $('.error1').show();
            $('.error1').text("Select Requested Employee");

            valid = false;
        }
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length);
        for (var i = 1; i < tbaleRowCount; i++) {
            var mt = $("#ItemId" + i).val();
            if ($("#ItemId" + i).val() == "") {
                $("#ItemId" + i).after('<span class="error" style="color:Red;">select Item</span>');
                $("#ItemId" + i).addClass('css-error');
                valid = false;
            }
            if ($("#QtyRequested" + i).val() == "") {
                $("#QtyRequested" + i).after('<span class="error" style="color:Red;">Enter Qty </span>');
                $("#QtyRequested" + i).addClass('css-error');
                valid = false;
            }
        }
        return valid;
    }
    function SaveDetails() {
        var valid = validatedetails();
        if (valid) {
            if (window.FormData !== undefined) {
                var files = "";
                var url = "/CMS/SaveItemTransfer";//Save
                // Create FormData object
                var fileData = new FormData();
                if (eId != 0) {
                    url = "/CMS/UpdateItemTransfer";//Update
                }
                fileData.append('ItemTransferId', eId);
                fileData.append('FromStoreId', $("#FromStoreId").val());
                fileData.append('ToStoreId', $("#ToStoreId").val());
                //fileData.append('ModeOfTransfer', $("#ModeOfTransfer").val());
                fileData.append('SenderEmpId', $("#SenderEmpId").val());
                fileData.append('SentOnDate', $("#SentOnDate").val());
                fileData.append('SentOnTime', $("#SentOnTime").val());
                fileData.append('RequestedEmpId', $("#RequestedEmpId").val());
                fileData.append('RequestedOn', $("#RequestedOn").val());
                fileData.append('RequestorNotes', $("#RequestorNotes").val());
                //fileData.append('FromLocationId', $("#FromLocationId").val());
                //fileData.append('ToLocationId', $("#ToLocationId").val());
                //fileData.append('IsCanteen', $("#IsCanteen").is(":checked"));
                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: false,
                    processData: false,
                    data: fileData,
                    success: function (data) {

                        SaveItem(data);
                        alert("Successfully Saved");
                        //window.location.reload();
                    },
                    error: function (err) {
                        alert(err.statusText);
                    }
                });
            } else {
                alert("FormData is not supported.");
            }
        }
    }
    function SaveItem(id) {
        var ItemList = [];
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length);
        for (var i = 1; i < tbaleRowCount; i++) {
            var row = $('#row' + i).html();
            if (typeof (row) !== 'undefined') {
                ItemList.push({

                    Id: parseInt($(".Id" + i).text()),
                    ItemTransferId: parseInt(id),
                    ItemId: parseInt($("#ItemId" + i).val()),
                    QtyRequested: parseInt($("#QtyRequested" + i).val()),
                    Notes: $("#Notes" + i).val()
                });
            }

        }

        $.post("/CMS/Save_UpdateItemTransferList", { model: ItemList}, function (res) {
            LoadPartialdivonclick('ManageCMSItemTransfer', 'Manage ItemTransfer');
        });
    }
    function inputvalidation(selector, Text) {

        var validate = true;
        if ($("#" + selector).val() == "") {
            $("#" + selector).after('<span class="error" style="color:Red;">' + Text + '</span>');
            $("#" + selector).addClass('css-error');
            validate = false;
        }
        return validate;
    }
    function cancel() {
        window.location.href = '/CMS/ManageCMSItemTransfer';
    }
    function AddItem(val) {
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length);
        if (table_len > 1) {
            if (eId == 0) {
                if ($("#ItemId" + (table_len - 1)).val() != "")
                    var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tbaleRowCount + "'><td class='Id" + tbaleRowCount + "' style='display:none;'>0</td><td> <select id='ItemId" + tbaleRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Item</option></select></td><td>  <input type='number' class='form-control' id='QtyRequested" + tbaleRowCount + "'></td><td>  <input type='text' class='form-control' id='Notes" + tbaleRowCount + "' /></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tbaleRowCount + ")'></span></td></tr>";
                   // <td>  <input type='number' class='form-control' id='QtySend" + table_len + "'></td><td>  <input type='number' class='form-control' id='QtyRecived" + table_len + "'></td><td>  <input type='number' class='form-control' id='QtyReturn" + table_len + "'></td><td>  <input type='number' class='form-control' id='QtyDamage" + table_len + "'></td>
                //var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + table_len + "'><td class='Id" + table_len + "' style='display:none;'>0</td><td class='ItemId" + table_len + "'>" + $("#ItemId").val() + "</td><td class='QtyRequested" + table_len + "'>" + $("#QtyRequested").val() + "</td><td class='QtySend" + table_len + "'>" + $('#QtySend').val() + "</td><td class='QtyRecived" + table_len + "'>" + $("#QtyRecived").val() + "</td><td class='QtyReturn" + table_len + "'>" + $("#QtyReturn").val() + "</td><td class='QtyDamage" + table_len + "'>" + $('#QtyDamage').val() + "</td><td class='Notes" + table_len + "'>" + $('#Notes').val() + "</td><td><span class='glyphicon glyphicon-edit' style='color:greem;cursor:pointer;' onclick='Edit_row(" + table_len + ")'></span> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + table_len + ")'></span></td></tr>";
                else
                    alert("select Item First");
            }
            else {
                var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tbaleRowCount + "'><td class='Id" + tbaleRowCount + "' style='display:none;'>0</td><td> <select id='ItemId" + tbaleRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Item</option></select></td><td>  <input type='number' class='form-control' id='QtyRequested" + tbaleRowCount + "'></td><td><input type='text' class='form-control' id='Notes" + tbaleRowCount + "' /></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tbaleRowCount + ")'></span></td></tr>";
                //<td>  <input type='number' class='form-control' id='QtySend" + table_len + "'></td><td>  <input type='number' class='form-control' id='QtyRecived" + table_len + "'></td><td>  <input type='number' class='form-control' id='QtyReturn" + table_len + "'></td><td>  <input type='number' class='form-control' id='QtyDamage" + table_len + "'></td>
            }
        }
        else {
            var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tbaleRowCount + "'><td class='Id" + tbaleRowCount + "' style='display:none;'>0</td><td> <select id='ItemId" + tbaleRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Item</option></select></td><td>  <input type='number' class='form-control' id='QtyRequested" + tbaleRowCount + "'></td><td><input type='text' class='form-control' id='Notes" + tbaleRowCount + "' /></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tbaleRowCount + ")'></span></td></tr>";
        }
        LoadItems(tbaleRowCount, val);
        tbaleRowCount++;
        $('#ItemTable').show();
        $("#myModalItem").modal('hide');
        }


    function delete_row(no) {
        document.getElementById("row" + no + "").outerHTML = "";
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length - 1);
        if (table_len == 0) {
            $('#ItemTable').hide();
        }
    }
    function update_row(no) {
        $(".ItemId" + no).text($("#ItemId").val());
        $(".QtyRequested" + no).text($("#QtyRequested").val());
        $(".QtySend" + no).text($("#QtySend").val());
        $(".QtyRecived" + no).text($("#QtyRecived").val());
        $(".QtyReturn" + no).text($("#QtyReturn").val());
        $(".QtyDamage" + no).text($("#QtyDamage").val());
        $(".Notes" + no).text($("#Notes").val());
    }
    function Edit_row(no) {

        $("#len").val(no);
        $("#ItemId").val($(".ItemId" + no).text());
        $("#QtyRequested").val($(".QtyRequested" + no).text());
        $("#QtySend").val($(".QtySend" + no).text());
        $("#QtyRecived").val($(".QtyRecived" + no).text());
        $("#QtyReturn").val($(".QtyReturn" + no).text());
        $("#QtyDamage").val($(".QtyDamage" + no).text());
        $("#Notes").val($(".Notes" + no).text());
        $("#myModalItem").modal('show');
    }
    function clearItem() {
        $("#len").val("0");
        $("#ItemId").val("");
        $("#QtyRequested").val("");
        $("#QtySend").val("");
        $("#QtyRecived").val("");
        $("#QtyReturn").val("");
        $("#QtyDamage").val("");
        $("#Notes").val("");
    }
    function LoadPartialdivonclick(link, title) {
        $("#titleofpage").html(title);
        $("#partialDiv").load("/CMS/" + link);
    }
</script>
<div class="alert alert-danger error1" role="alert">

</div>
<div class="row" style="width:95%;margin:auto;">

    <div class="col-md-12">
        <table class="table table-stribbed">
            <tr>
                <td>
                    <label>Main Store<span class="text-danger">*</span> </label>
                </td>
                <td>
                    <select class="form-control StoreId" id="FromStoreId"></select>
                </td>
                <td>&nbsp;</td>
                <td>
                    <label>Requestor/Receiver Store<span class="text-danger">*</span></label>
                </td>
                <td>
                    <select class="form-control StoreId" id="ToStoreId"></select>
                </td>

            </tr>
            <tr>
                <td>
                    <label>Requested EmpId <span class="text-danger">*</span></label>
                </td>
                <td>
                    <select id="RequestedEmpId" style="width: 120%" class="form-control typeahead EmpId" name="query" data-provide="typeahead" autocomplete="off"></select>

                </td>
                <td>&nbsp;</td>
                <td>
                    <label>Requested On<span class="text-danger">*</span></label>
                </td>
                <td>
                    <input type="text" name="RequestedOn" id="RequestedOn" class="form-control date" />
                </td>
            </tr>

            @*<tr>
                <td>
                    <label>From Location<span class="text-danger">*</span></label>
                </td>
                <td>
                    <select class="form-control Location" id="FromLocationId"></select>
                </td>
                <td>&nbsp;</td>
                <td>
                    <label>To Location<span class="text-danger">*</span></label>
                </td>
                <td>
                    <select class="form-control Location" id="ToLocationId"></select>
                </td>
            </tr>*@

            <tr>
                <td>
                    <label>Requestor Notes</label>
                </td>
                <td>

                    <textarea class="form-control" id="RequestorNotes"></textarea>
                </td>
                @*<td>&nbsp;</td>
                <td>
                    <label>Mode Of Transfer<span class="text-danger">*</span></label>
                </td>
                <td>
                    <select class="form-control" id="ModeOfTransfer"><option value="">Select ModeOfTransfer </option><option value="Van">Van</option></select>
                </td>*@
            </tr>
            <tr style="display:none;">
                <td>
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="IsCanteen" name="IsCanteen">
                        <label class="custom-control-label" for="IsCanteen">IsCanteen</label>
                    </div>
                </td>
            </tr>
        </table>
        <table id="ItemTable" class="table table-borderedtable-condensed table-striped">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty Requested</th>
                    <th>Notes</th>
                    <th>Action <a href="javascript:void(0)" class="pull-right" style="color:green;font-size:14px;" onclick="AddItem();"><span class="glyphicon glyphicon-plus"></span></a></th>
                </tr>
            </thead>
        </table>
    </div>
    <br />
    <div class="form-group col-md-6">
        <br />
        <button type="button" class="btn save" onclick="SaveDetails();">SAVE</button>
        <button type="button" onclick="LoadPartialdivonclick('ManageCMSItemTransfer','Manage ItemTransfer');" class="btn cancel">Cancel</button>
    </div>
    <div class="clearfix"></div>
</div>