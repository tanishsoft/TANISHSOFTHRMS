

<script>
    var eId = @ViewBag.id;
    var tableRowCount = 1;
    $(document).ready(function () {
        $('.error1').hide();
        $("#StockRecivedOn").datepicker({
            changeMonth: true,
            changeYear: true,
            dateFormat: "dd/mm/yy",
            Edit: true,
            minDate: 0
        });
        LoadItems();
        LoadStore();
        EmployeeSearch();
        if (eId != 0) {
            LoadData(eId);
            LoadItemsDetails(eId);
        }
        else {
            AddItem();
        }
    });
    function LoadItems(id, val) {
        $.ajax({
            type: "POST",
            url: "/CMS/GetCMS_Items",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Item -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].ItemId + '">' + data[i].ItemName + '</option>');
                }
                $("#ItemId").html(options.join(''));
                $("#ItemId" + id).html(options.join(''));

                var table = document.getElementById("ItemTable");
                var table_len = (table.rows.length);
                for (var i = 1; i < tableRowCount; i++) {
                    var mealtype = $("#ItemId" + i).val();
                    if (mealtype != "") {
                        $("#ItemId" + id + " option[value=" + mealtype + "]").remove();
                    }

                }
                var len = $("#ItemId" + id + " option").length;
                if (len == 1) {
                    delete_row(id);
                }
                if (val != "")
                    $("#ItemId" + id).val(val);
            },

            error: function () {
                alert("error")
            }
        });
    }
    function EmployeeSearch(){

        $("#StockRecivedEmpId").select2({
            ajax: {
                url: "/Home/GetEmployeeSearch",
                type: "get",
                dataType: 'json',

                //delay: 250,
                data: function (params) {
                    return {
                        searchTerm: params.term // search term
                    };
                },
                processResults: function (response) {
                    return {
                        results: response
                    };
                },
                cache: true
            },
            width: 'element',
            minimumInputLength: 3
        });
        $("#StockRecivedEmpId").val($("#hidcurrentuserid").val());
    }
    function LoadData(id) {
        $.get("/CMS/GetCMS_Stock_ById?id=" + id, function (res) {
            debugger;
            $("#StoreId").val(res.StoreId);
            $("#StockRecivedOn").val(res.StockRecivedOn);
            $("#StockRecivedEmpId").select2("trigger", "select", { data: { id: res.StockRecivedEmpId, text: res.StockRecivedEmpName } });
            $("#TotalItems").val(res.TotalItems);
            $("#TotalItemsAccepted").val(res.TotalItemsAccepted);
            $("#StockRecivedNotes").val(res.StockRecivedNotes);
            $("#TotalItemsReturn").val(res.TotalItemsReturn);
            $("#TotalItemsDamage").val(res.TotalItemsDamage);
            $("#header").text("Update Stock");
        });
    }
    function LoadItemsDetails(id) {
        $.get("/CMS/GetCMS_stockItems_ByResId?id=" + id, function (res) {
            var table = document.getElementById("ItemTable");
            for (var i = 0; i < res.length; i++) {
                AddItem(res[i].ItemId);
                $("#QtyRequested" + (i + 1)).val(res[i].QtyRequested);
                $(".Id" + (i + 1)).text(res[i].Id);
                $("#QtyRecived" + (i + 1)).val(res[i].QtyRecived);
                $("#QtyReturn" + (i + 1)).val(res[i].QtyReturn);
                $("#QtyDamage" + (i + 1)).val(res[i].QtyDamage);
               /* $("#Notes" + (i + 1)).val(res[i].Notes);*/
            }
        });
    }
    function LoadStore() {
        $.ajax({
            type: "POST",
            url: "/CMS/GetCMS_Store",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Store -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].StoreId + '">' + data[i].StoreName + '</option>');
                }
                $("#StoreId").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function validatedetails() {
        var valid = true;
        setTimeout(function () { $('.error1').fadeOut('fast'); }, 5000);
        $(".error").hide();
        $(".css-error").removeClass('css-error');
        if (!inputvalidation('TotalItems', 'Enter Total Items')) valid=false;
        if (!inputvalidation('TotalItemsAccepted', 'Enter TotalItemsAccepted')) valid = false;
        if (!inputvalidation('StockRecivedOn', 'select Recived Date')) valid = false;
        if (!inputvalidation('StoreId', 'select Store')) valid = false;
        if (!inputvalidation('TotalItemsReturn', 'Enter Total Items Return')) valid = false;
        if (!inputvalidation('TotalItemsDamage', 'Enter Total Items Damage')) valid = false;
        if ($("#StockRecivedEmpId").val() == null) {
            $('.error1').show();
            $('.error1').text("Select Recived Employee");
            valid = false;
        }
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length);

        for (var i = 1; i < tableRowCount; i++) {
            var mt = $("#ItemId" + i).val();
            if ($("#ItemId" + i).val() == "") {
                $("#ItemId" + i).after('<span class="error" style="color:Red;">select Item</span>');
                $("#ItemId" + i).addClass('css-error');
                valid = false;
            }
        }
        return valid;
    }
    function SaveDetails() {

        var valid = validatedetails();
        if (valid) {
            var task = {
                ReceivedStockId: eId,
                StoreId: $("#StoreId").val(),
                StockRecivedOn: $("#StockRecivedOn").val(),
                StockRecivedEmpId: $("#StockRecivedEmpId").val(),
                TotalItems: $("#TotalItems").val(),
                TotalItemsAccepted: $("#TotalItemsAccepted").val(),
                TotalItemsDamage: $("#TotalItemsDamage").val(),
                TotalItemsReturn: $("#TotalItemsReturn").val(),
                StockRecivedNotes: $("#StockRecivedNotes").val(),
                IsActive: true
            };

            $.ajax({
                type: "POST",
                url: "/CMS/Save_UpdateCMSStock",
                data: task,
                success: function (data) {
                    SaveItem(data);

                    //window.location.reload();
                }
            });
        }
    }
    function SaveItem(id) {
        var ItemList = [];
        var table = document.getElementById("ItemTable");
        var table_len = (table.rows.length);
        for (var i = 1; i < tableRowCount; i++) {
            debugger;
            var row = $('#row' + i).html();
            if (typeof (row) !== 'undefined') {
                ItemList.push({
                    Id: parseInt($(".Id" + i).text()),
                    ReceivedStockId: parseInt(id),
                    ItemId: parseInt($("#ItemId" + i).val()),
                    QtyRequested: 0,
                    QtySend: 0,
                    QtyRecived: parseFloat($("#QtyRecived" + i).val()).toFixed(2),
                    QtyReturn: parseFloat($("#QtyReturn" + i).val()).toFixed(2),
                    QtyDamage: parseFloat($("#QtyDamage" + i).val()).toFixed(2),
                    Notes: $("#Notes" + i).val()
                });
            }

        }
        $.post("/CMS/Save_UpdateReceivedStockList", { model: ItemList }, function (res) {
            LoadPartialdivonclick('ManageCMStock', 'Manage Stock');
        });
    }
    function inputvalidation(selector, Text) {
        var validate = true;
        if ($("#" + selector).val() == "") {
            $("#" + selector).after('<span class="error" style="color:Red;">' + Text + '</span>');
            $("#" + selector).addClass('css-error');
            validate = false;
        }
        return validate;
    }
    function cancel() {
        window.location.href = '/CMS/ManageCMStock';
    }
    function AddItem(val) {
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length);
        if (table_len > 1) {

            if (eId == 0) {
                if ($("#ItemId" + (table_len - 1)).val() != "")
                    var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tableRowCount + "'><td class='Id" + tableRowCount + "' style='display:none;'>0</td><td> <select id='ItemId" + tableRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Item</option></select></td><td>  <input type='number' class='form-control' id='QtyRecived" + tableRowCount + "'></td><td>  <input type='number' class='form-control' id='QtyReturn" + tableRowCount + "'></td><td>  <input type='number' class='form-control' id='QtyDamage" + tableRowCount + "'></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tableRowCount + ")'></span></td></tr>";
                    //var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + table_len + "'><td class='Id" + table_len + "' style='display:none;'>0</td><td class='ItemId" + table_len + "'>" + $("#ItemId").val() + "</td><td class='QtyRequested" + table_len + "'>" + $("#QtyRequested").val() + "</td><td class='QtySend" + table_len + "'>" + $('#QtySend').val() + "</td><td class='QtyRecived" + table_len + "'>" + $("#QtyRecived").val() + "</td><td class='QtyReturn" + table_len + "'>" + $("#QtyReturn").val() + "</td><td class='QtyDamage" + table_len + "'>" + $('#QtyDamage').val() + "</td><td>  <textarea class='form-control' id='Notes" + tableRowCount + "'></textarea></td><td class='Notes" + table_len + "'>" + $('#Notes').val() + "</td><td><span class='glyphicon glyphicon-edit' style='color:greem;cursor:pointer;' onclick='Edit_row(" + table_len + ")'></span> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + table_len + ")'></span></td></tr>";
                else
                    alert("select Item First");
            }
            else {
                var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tableRowCount + "'><td class='Id" + tableRowCount + "' style='display:none;'>0</td><td> <select id='ItemId" + tableRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Item</option></select></td><td>  <input type='number' class='form-control' id='QtyRecived" + tableRowCount + "'></td><td>  <input type='number' class='form-control' id='QtyReturn" + tableRowCount + "'></td><td>  <input type='number' class='form-control' id='QtyDamage" + tableRowCount + "'></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tableRowCount + ")'></span></td></tr>";
            }
        }
            else {
            var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tableRowCount + "'><td class='Id" + tableRowCount + "' style='display:none;'>0</td><td> <select id='ItemId" + tableRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Item</option></select></td><td>  <input type='number' class='form-control' id='QtyRecived" + tableRowCount + "'></td><td>  <input type='number' class='form-control' id='QtyReturn" + tableRowCount + "'></td><td>  <input type='number' class='form-control' id='QtyDamage" + tableRowCount + "'></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tableRowCount + ")'></span></td></tr>";
            }

        LoadItems(tableRowCount, val);
        tableRowCount++;
        $('#ItemTable').show();
        $("#myModalItem").modal('hide');
    }
    function delete_row(no) {
        document.getElementById("row" + no + "").outerHTML = "";
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length - 1);
        if (table_len == 0) {
            $('#ItemTable').hide();
        }
    }
    function update_row(no) {
        $(".ItemId" + no).text($("#ItemId").val());
        //$(".QtyRequested" + no).text($("#QtyRequested").val());
        //$(".QtySend" + no).text($("#QtySend").val());
        $(".QtyRecived" + no).text($("#QtyRecived").val());
        $(".QtyReturn" + no).text($("#QtyReturn").val());
        $(".QtyDamage" + no).text($("#QtyDamage").val());
        $(".Notes" + no).text($("#Notes").val());
    }
    function Edit_row(no) {

        $("#len").val(no);
        $("#ItemId").val($(".ItemId" + no).text());
        //$("#QtyRequested").val($(".QtyRequested" + no).text());
        //$("#QtySend").val($(".QtySend" + no).text());
        $("#QtyRecived").val($(".QtyRecived" + no).text());
        $("#QtyReturn").val($(".QtyReturn" + no).text());
        $("#QtyDamage").val($(".QtyDamage" + no).text());
        $("#Notes").val($(".Notes" + no).text());
        $("#myModalItem").modal('show');
    }
    function clearItem() {
        $("#len").val("0");
        $("#ItemId").val("");
        //$("#QtyRequested").val("");
        //$("#QtySend").val("");
        $("#QtyRecived").val("");
        $("#QtyReturn").val("");
        $("#QtyDamage").val("");
        $("#Notes").val("");
    }
    var poitemsdata = [];
    function UpdatePONumberstock() {
        var id = $("#txtPONumber").val();
        if (confirm("Are you sure you want to update stock for the PO Number : " + id)) {
            $.get("/CMS/UpdateStockfromserver?ponumber=" + id, function (data) {
                //EditStock(data);
                var html = "<br /><table class='table table-bordered'><tr><td>Item </td><td>Qty</td><td>Rate</td><td>Location</td><td>Action</td></tr>";
                var tableRowCount = 1;
                poitemsdata = data;
                for (var i = 0; i < poitemsdata.length; i++) {
                    poitemsdata[i].id = tableRowCount;
                    html += "<tr  class='datarow' id='rowcheck" + tableRowCount + "'><td>" + data[i].itemname + "</td><td>" + data[i].qty + "</td><td>" + data[i].rate + "</td><td>" + getlocationame(data[i].locid) + "</td><td> <input type='checkbox' id='cbcheck_" + tableRowCount+"' /></td></tr>";
                    tableRowCount++;
                }
                $("#divhtmldata").html(html);
            });
        }
    }
    function EditStock(id) {
        EditLoadPartialdivonclick("CreateCMStock", "Update Stock", id);
    }
    function delete_row3(no) {
        document.getElementById("rowcheck" + no + "").outerHTML = "";
        var updatepoitemsdata = poitemsdata;
        poitemsdata = [];
        for (var i = 0; i < updatepoitemsdata.length; i++) {
            if (updatepoitemsdata[i].id != no) {
                poitemsdata.push(updatepoitemsdata[i]);
            }
        }
    }
    function getlocationame(id) {
        var locname = "";
        switch (id) {
            case "Loc00006":
                locname = "HYDERGUDA-UNIT4";
                break;
            case "Loc00001":
                locname = "BOGULKUNTA";
                break;
            case "Loc00002":
                locname = "JUBILEE HILLS";
                break;
            case "Loc00003":
                locname = "FAST TRACK OP BOGULKUNTA";
                break;
            case "Loc00004":
                locname = "HYDERGUDA";
                break;
            case "Loc00005":
                locname = "SUPER DELUX HG";
                break;
            case "Loc00007":
                locname = "FAST TRACK OP HYDERGUDA UNIT- 4";
                break;
            case "Loc00008":
                locname = "FERNANDEZ SCHOOL OF NURSING";
                break;
            case "Loc00009":
                locname = "STUDENTS";
                break;
            case "Loc00010":
                locname = "BANJARA HILLS";
                break;
            case "Loc00011":
                locname = "FAST TRACK OP SH";
                break;
            case "Loc00012":
                locname = "MIYAPUR";
                break;
            case "Loc00013":
                locname = "FERNANDEZ CDC";
                break;
            case "Loc00014":
                locname = "Head Office";
                break;
            case "Loc00015":
                locname = "Corporate Office";
                break;
            case "Loc00016":
                locname = "FF MIDWIFERY";
                break;
            case "Loc00017":
                locname = "FF BABYSTORE BANJARAHILLS";
                break;
            case "Loc00018":
                locname = "FF Kitchen";
                break;
            case "Loc00019":
                locname = "FF NECKLACE ROAD";
                break;
        }
        return locname;
    }
    function EditLoadPartialdivonclick(link, title, id) {
        $("#titleofpage").html(title);
        $("#partialDiv").load("/CMS/" + link + "?id=" + id);
    }
    function SaveDetails3() {
        var updatepoitemsdata = poitemsdata;
        poitemsdata = [];
        for (var i = 0; i < updatepoitemsdata.length; i++) {
            var no = "#cbcheck_" + updatepoitemsdata[i].id;
            if ($(no).prop('checked')) {
                poitemsdata.push(updatepoitemsdata[i]);
            }
        }

        if ($("#StoreId").val() != null && $("#StoreId").val() != "") {
            var task = {
                StoreId: $("#StoreId").val(),
                model: poitemsdata
            };
            $.ajax({
                type: "POST",
                url: "/CMS/SaveItemspurchase",
                data: task,
                success: function (data) {
                    alert(data);
                    poitemsdata = [];
                    $("#divhtmldata").html("");

                }
            });
        } else {
            alert("Please select the Store");
        }

    }
</script>
<div class="alert alert-danger error1" role="alert">

</div>

<div class="row" style="width:95%;margin:auto;">


    <div class="col-md-12">
        <table class="table table-stribbed">
            <tr>
                <td>
                    <label>Store<span class="text-danger">*</span> </label>
                </td>
                <td>
                    <select class="form-control" id="StoreId"></select>
                </td>
                <td>&nbsp;</td>
                <td>
                    <label>Recived Date<span class="text-danger">*</span></label>
                </td>
                <td>
                    <input type="text" name="Reciveddate" value="@DateTime.Now.ToString("dd/MM/yyyy")" disabled="disabled" id="StockRecivedOn" class="form-control" />
                </td>
            </tr>
            <tr style="display:none;">


                <td>
                    <label>Total Items<span class="text-danger">*</span></label>
                </td>
                <td>
                    <input type="number" name="TotalItems" value="0" id="TotalItems" class="form-control" />
                </td>
                <td>&nbsp;</td>
                <td>
                    <label>Total Items Accepted<span class="text-danger">*</span></label>
                </td>
                <td>
                    <input type="number" name="TotalItemsAccepted" value="0" id="TotalItemsAccepted" class="form-control" />
                </td>
            </tr>
            <tr style="display:none;">


                <td>
                    <label>Total Items Return<span class="text-danger">*</span></label>
                </td>
                <td>
                    <input type="number" name="TotalItemsReturn" value="0" id="TotalItemsReturn" class="form-control" />
                </td>
                <td>&nbsp;</td>
                <td>
                    <label>Total Items Damage</label>
                </td>
                <td>
                    <input type="number" name="TotalItemsDamage" value="0" id="TotalItemsDamage" class="form-control" />
                </td>
            </tr>
            <tr>

                <td>
                    <label>Recived Notes</label>
                </td>
                <td>
                    <textarea class="form-control" name="StockRecivedNotes" id="StockRecivedNotes"></textarea>
                </td>
                <td>&nbsp;</td>
                <td>
                    <label>Recived EmpId<span class="text-danger">*</span></label>
                </td>

                <td>
                    <select id="StockRecivedEmpId" style="width: 120%" class="form-control typeahead" name="query" data-provide="typeahead" autocomplete="off"></select>
                </td>
            </tr>
            <tr>
            </tr>
        </table>
    </div>

    <div class="col-md-7" style="background-color:#eee;">
        <h4 style="text-align:center"> Update Stock Manually</h4>
        <a href="javascript:void(0)" class="pull-right" onclick="AddItem();">New</a>
        <table id="ItemTable" class="table table-borderedtable-condensed table-striped">
            <thead>
                <tr>
                    <th>Item</th>
                    @*<th>Qty Requested</th>
                        <th>Qty Send</th>*@
                    <th>Qty Recived</th>
                    <th>Qty Return</th>
                    <th>Qty Damage</th>
                    @*<th>Notes</th>*@
                    <th>Action</th>
                </tr>
            </thead>
        </table>
        <div class="form-group col-md-6">
            <button type="button" class="btn save" onclick="SaveDetails();">SAVE Manuval Stock</button>
            <button type="button" onclick="LoadPartialdivonclick('ManageCMStock','Manage Stock');" class="btn cancel">Cancel</button>
        </div>
    </div>
    <div class="col-md-5">
        <table class="table table-bordered" style="width:100%;margin:auto;">
            <tr>
                <td colspan="3">
                    Update Stock From Server Automatically
                </td>
            </tr>
            <tr>
                <td>Enter PO Number : </td>
                <td>
                    <input type="text" id="txtPONumber" class="form-control" />
                </td>
                <td><input type="button" id="btn" value="Get Items" class="btn btn-primary" onclick="UpdatePONumberstock();" /></td>
            </tr>
        </table>
        <div id="divhtmldata">

        </div>
        <div class="form-group col-md-6" style="margin-top:10px">
            <button type="button" class="btn save" onclick="SaveDetails3();">SAVE Items</button>

        </div>
    </div>


    <div class="clearfix"></div>
</div>

<br />