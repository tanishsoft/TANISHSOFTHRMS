
@{
    ViewBag.Title = "Asset Master";
}
<script>
    var eId = 0;
    $(document).ready(function () {

        LoadData();
        LoadAssetType();
        $("#SPurchaseDate")
            .datepicker({
                changeMonth: true,
                changeYear: true,
                dateFormat: "dd/mm/yy",
                Edit: true

            })
    });
    function LoadData() {
        $('#tblAssetMaster').dataTable({
            "bServerSide": true,
            "sAjaxSource": "/Asset/AjaxGetAssetDetails",
            "bProcessing": true,
            "bDestroy": true,
            "aLengthMenu": [[10, 20, 30, 50, 100, 150, 200, -1], [10, 20, 30, 50, 100, 150, 200, "All"]],
            "aoColumns": [
                { "sName": "AssetId" },
                { "sName": "AssetTypeId" },
                { "sName": "Name" },
                { "sName": "Description" },
                { "sName": "VendorId" },
                { "sName": "Price" },
                { "sName": "Quantity" },
                { "sName": "Warranty" },
                { "sName": "PurchaseDate" },
                { "sName": "SerialNumber" },
                {
                    "sName": "Status",                
                },
                {
                    "sName": "AssetTypeId",
                    "bSortable": false,
                    "render": function (data) {
                        return GetHtmlContent(data);
                        //+
                        //'<a href="javascript:void(0);" id="' + data + '" class="btn btn-primary" onclick="ManageDocuments(this.id);"><span class="glyphicon glyphicon-file"></span></a>';;
                    }
                }],
            "fnServerParams": function (aoData) {
                aoData.push(
                    { "name": "AssetTypeId", "value": $("#SddlAssetType").val() },
                    { "name": "todate", "value": $("#SPurchaseDate").val() },
                    { "name": "status", "value": $("#SddlStatus").val() }
                );
            }
        });
        $("#tblAssetMaster_length").addClass("col-md-6");
        $("#tblAssetMaster_length").addClass("col-md-6");
    }

    function GetHtmlContent(data) {

        var htmlcontect = "";
        if (data != "0") { 
        htmlcontect += '<div class="btn-group">';
        htmlcontect += '<div class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-th-list"></span></div>';
        htmlcontect += '<ul class="dropdown-menu dropdown-menu-right">';
        htmlcontect += '<li><a href="javascript:void(0);" id="' + data + '" onclick="Edit(this.id);"><span class="glyphicon glyphicon-edit"></span>&nbsp;Edit&nbsp;</a></li>';
        htmlcontect += '<li><a href="javascript:void(0);" id="' + data + '" onclick="View(this.id);"><span class="glyphicon glyphicon-folder-open"></span>&nbsp;View&nbsp;</a></li> ';
        htmlcontect += '<li><a href="javascript:void(0);" id="' + data + '" onclick="ViewHistory(this.id);"><span class="glyphicon glyphicon-folder-open"></span>&nbsp;History&nbsp;</a></li> ';
        htmlcontect += '<li><a href="javascript:void(0);" id="' + data + '" onclick="Print(this.id);"><span class="glyphicon glyphicon-print"></span>&nbsp;Print&nbsp;</a></li> ';
        htmlcontect += '<li><a href="javascript:void(0);" id="' + data + '" onclick="GenerateBarcode(this.id);"><span class="glyphicon glyphicon-barcode"></span>&nbsp;Barcode&nbsp;</a></li> ';
        htmlcontect += '<li><a href="javascript:void(0);" id="' + data + '" onclick="UpdateScrap(this.id);"><span class="glyphicon glyphicon-edit"></span>&nbsp;Scrap&nbsp;</a></li> ';
       // htmlcontect += '<li><a href="javascript:void(0);" id="' + data + '" onclick="Delete(this.id);"><span class="glyphicon glyphicon-trash"></span>&nbsp;Delete&nbsp;</a></li> ';
            htmlcontect += '</ul></div>';
        }
        return htmlcontect;
    }
    var currentAssetId = 0;
    function ViewHistory(id) {
        currentAssetId = id;
        $.get("/Asset/GetAssetHistory?assetId=" + id, function (data) {
            var html = "<table class='table'><tr><td>Date</td><td>Description</td></tr>";
            for (var i = 0; i < data.length; i++) {
                html += "<tr><td>" + data[i].DateOfLog + "</td><td>" + data[i].LogSubject + "</td></tr>";
            };
            html += "</table>";
            $("#ViewAssetHistory").html(html);
            $("#myModalViewDetails").modal('show');
        });
    }
    function UpdateScrap(id) {
        currentAssetId = id;
        $("#myModalScapDetails").modal('show');
    }
    function ScrapAssetDetails() {
        if (confirm("Are you sure you want to Scrap the Asset?")) {
            $.get("/Asset/UpdateToScrapAsset?assetId=" + id + "&comments=" + $("#txtAssetScrapComments").val(), function (data) {
                $("#myModalScapDetails").modal('hide');
                alert(data);
                LoadData();
            });
        }
    }
    function UpdateAssetComments() {
        $.get("/Asset/AddAssetHistory?assetId=" + currentAssetId + "&comments=" + $("#txtAssetComments").val(), function (data) {
            alert(data);
            $("#txtAssetComments").val("");
            ReloadViewHistory(currentAssetId);
        });
    }
    function ReloadViewHistory(id) {       
        $.get("/Asset/GetAssetHistory?assetId=" + id, function (data) {
            var html = "<table class='table'><tr><td>Date</td><td>Description</td></tr>";
            for (var i = 0; i < data.length; i++) {
                html += "<tr><td>" + data[i].DateOfLog + "</td><td>" + data[i].LogSubject + "</td></tr>";
            };
            html += "</table>";
            $("#ViewAssetHistory").html(html);          
        });
    }
    function Edit(id) {
        window.location.replace("/Asset/CreateAsset?id=" + id);
    }
    function View(id) {
        window.location.replace("/Asset/ViewAsset?id=" + id);
    }
    function Print(id) {
        if (id != 0) {
            $.get("/Asset/ViewAssetPartial", { id: id }, function (data) {                
                var printContents = data;
                var originalContents = document.body.innerHTML;
                document.body.innerHTML = printContents;
                window.print();
                document.body.innerHTML = originalContents;
            });
        }
    }
    function GenerateBarcode(id) {
        $.get("/Asset/PrintLabel?id=" + id, function (data) {
            printZpl(data);
        });
        //window.open("/Asset/PrintLabel?id=" + id);
    }
    function printZpl(zpl) {
        var printWindow = window.open();
        printWindow.document.open('text/plain')
        printWindow.document.write(zpl);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }
    function Delete(id) {
        if (confirm("Are you sure you want to delete?")) {
            $.get("/Asset/DeleteAssets?id=" + id, function (data) {
                alert("Success");
                LoadData();
            });
        }
    }
    function ManageDocuments(id) {
        GetFiles(id);
    }
    function ChangeStatus(id) {
        eId = id;
        $("#myModalChangeStatus").modal('show');
    }

    function SaveChangeStatus() {
        if ($("#ddlChangeStatus").val() != "") {
            $.get("/Asset/ChangeStatus?status=" + $("#ddlChangeStatus").val(), { id: eId }, function (data) {
                LoadData();
                $("#myModalChangeStatus").modal('hide');
            });
        }
        else {
            alert("please select Status");
        }
    }
    function ViewComponents(id) {
        $('#tblComponent tbody').empty();
        $.get("/Asset/GetAssetandcomponents", { id: id }, function (data) {            
            $("#myModalComponents").modal('show');
            for (var i = 0; i < data.AssetTypeComponents.length; i++) {                
                var html = '<tr><td><label>' + data.AssetTypeComponents[i].Meta.Name + '</label></td><td><label>' + data.AssetTypeComponents[i].Post.Manufacturer + '</label></td><td><label>' + data.AssetTypeComponents[i].Post.Model + '</label></td><td><label>' + data.AssetTypeComponents[i].Post.Price + '</label></td><td><label>' + data.AssetTypeComponents[i].Post.Quantity + '</label></td><td><label>' + data.AssetTypeComponents[i].Post.SerialNumber + '</label></td></tr>'
                $('#tblComponent').append(html);
            }
        });
    }
    function LoadAssetType() {
        $.ajax({
            type: "POST",
            url: "/Asset/GetAssetType",
            success: function (data) {
                var options = [];
                options.push('<option value="">- select AssetType -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].AssetTypeId + '">' + data[i].Name + '</option>');
                }
                $("#SddlAssetType").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function ExportExcelAssets() {
        var assettype = '';
        if ($("#SddlAssetType").val() != null && $("#SddlAssetType").val() != "") {
            assettype = $("#SddlAssetType").val();
        }
        var purchasedate = '';
        if ($("#SPurchaseDate").val() != null && $("#SPurchaseDate").val() != "") {
            purchasedate = $("#SPurchaseDate").val();
        }
        var status = '';
        if ($("#SddlStatus").val() != null && $("#SddlStatus").val() != "") {
            status = $("#SddlStatus").val();
        }
        window.location = '/Asset/ExportExcelAssets?assettype=' + assettype + '&date=' + purchasedate + '&status=' + status;
    }
</script>

<div class="panel panel-default">
    <div class="panel-heading">Manage Asset<a href="/Asset/CreateAsset?id=0" class="pull-right">New Asset </a></div>
    <div class="panel-body">
        <div class="row">

            <table class="table">
                <tr>
                    <td>
                        <select id="SddlAssetType" class="form-control">
                            <option value="">Select Asset Type</option>
                        </select>
                    </td>
                    <td>
                        <input class="form-control" autocomplete="off" type="text" placeholder="Purchase Date" id="SPurchaseDate" />
                    </td>
                    <td>
                        <select id="SddlStatus" class="form-control">
                            <option value="">select Status</option>
                            <option value="New">New</option>
                            <option value="Allocated">Allocated</option>
                            <option value="Scrap">Scrap</option>
                            <option value="Deallocated">Deallocated</option>
                        </select>
                    </td>
                    <td>
                        <input type="button" class="btn btn-danger" id="btnGo" onclick="LoadData();" value="Go" />
                        <input type="button" class="btn btn-primary" id="btnExcel" onclick="ExportExcelAssets();" value="Export Excel" />
                    </td>
                </tr>
            </table>
        </div>
        <table class="table table-striped table-bordered dt-responsive nowrap" style="width:100%;" id="tblAssetMaster">
            <thead>
                <tr style="background-color: #786C67;color: white;">
                    <th>Id</th>
                    <th>Asset Type</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Vendor</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Warranty</th>
                    <th>Purchase Date</th>
                    <th>Serial Number</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="myModalChangeStatus" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h4 class="modal-title">Change Status</h4>
            </div>
            <div class="modal-body">
                <div class="form-control-static">
                    <label>Status <span style="color:red;">*</span></label>
                    <select id="ddlChangeStatus" class="form-control">
                        <option value="">select Status</option>
                        <option value="New">New</option>
                        <option value="Allocated">Allocated</option>
                        <option value="Deallocated">Deallocated</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <input type="button" value="Save" class="btn btn-primary" onclick="SaveChangeStatus();" />
            </div>
        </div>

    </div>
</div>

<div id="myModalComponents" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h4 class="modal-title">Components</h4>
            </div>
            <div class="modal-body">
                <div class="form-control-static">
                    <table id="tblComponent" class="table table-bordered text-center">
                        <thead>
                            <tr style="background-color:#eee;">
                                <th style="width:50px">Component Name</th>
                                <th style="width:50px">Manufacturer</th>
                                <th style="width:50px">Model</th>
                                <th style="width:50px">Price</th>
                                <th style="width:50px">Quantity</th>                           
                                <th style="width:50px">SerialNumber</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>

    </div>
</div>


<div id="myModalViewDetails" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h4 class="modal-title">View</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        Enter Comments
                    </div>
                    <div class="col-md-4">
                        <textarea id="txtAssetComments" class="form-control" autocomplete="off"></textarea>
                    </div>
                    <div class="col-md-4">
                        <input type="button" id="btnpr" class="btn btn-primary" value="Save" onclick="UpdateAssetComments();" />
                    </div>
                </div>
                <div id="ViewAssetHistory">

                </div>
            </div>
        </div>
    </div>
</div>

<div id="myModalScapDetails" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h4 class="modal-title">Scrap The Asset</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        Enter Comments
                    </div>
                    <div class="col-md-4">
                        <textarea id="txtAssetScrapComments" class="form-control" autocomplete="off"></textarea>
                    </div>
                    <div class="col-md-4">
                        <input type="button" id="btnpr" class="btn btn-primary" value="Scrap Asset" onclick="ScrapAssetDetails();" />
                    </div>
                </div>
              
            </div>
        </div>
    </div>
</div>