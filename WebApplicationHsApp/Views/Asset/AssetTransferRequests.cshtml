
@{
    ViewBag.Title = "AssetTransferRequests";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script>
    var eId = 0;
    $(document).ready(function () {
        LoadTransferData();
        LoadLocations1();
    });
    function LoadLocations1() {
        $.ajax({
            type: "POST",
            url: "/Common/GetLocations",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Location -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].LocationId + '">' + data[i].LocationName + '</option>');
                }
                ddlFromlocation1
                $("#ddllocation1").html(options.join(''));
                $("#ddlFromlocation1").html(options.join(''));

            },
            error: function () {
                alert("error")
            }
        });
    }
    function LoadDepartment123(val,emp) {
        if ($("#ddllocation1").val() != "") {
            $.ajax({
                type: "GET",
                url: "/Common/GetDepartmentByLocation",
                data: "id=" + $("#ddllocation1").val(),
                success: function (data) {
                    var options = [];
                    options.push('<option value="">- Select Department -</option>');
                    for (var i = 0; i < data.length; i++) {
                        options.push('<option value="' + data[i].DepartmentId + '">' + data[i].DepartmentName + '</option>');
                    }
                    $("#ddldepartment12").html(options.join(''));
                    if (val != ""){
                        $("#ddldepartment12").val(val);
                        LoadDepartmentEmployees(emp);
            }
                },
                error: function () {
                    alert("error")
                }
            });
        }
        else {
            $("#ddldepartment12").html('<option value="">- Select Department -</option>');
        }

    }


    function LoadDepartmentEmployees() {
        if ($("#ddldepartment12").val() != "") {
            $.ajax({
                type: "POST",
                url: "/Common/GetEmployeesByDepartment",
                data: "id=" + $("#ddldepartment12").val(),
                success: function (data) {
                    var options = [];
                    options.push('<option value="">- Select User -</option>');
                    for (var i = 0; i < data.length; i++) {
                        options.push('<option value="' + data[i].CustomUserId + '">' + data[i].FirstName + " " + data[i].LastName + '</option>');
                    }
                    $("#ddlEmployee123").html(options.join(''));
                },
                error: function () {
                    alert("error")
                }
            });
        }
        else {
            $("#ddlEmployee123").html('<option value="">- Select User -</option>');
        }
    }

    function LoadDepartmentNew(val,emp) {
        if ($("#ddlFromlocation1").val() != "") {
            $.ajax({
                type: "GET",
                url: "/Common/GetDepartmentByLocation",
                data: "id=" + $("#ddlFromlocation1").val(),
                success: function (data) {
                    var options = [];
                    options.push('<option value="">- Select Department -</option>');
                    for (var i = 0; i < data.length; i++) {
                        options.push('<option value="' + data[i].DepartmentId + '">' + data[i].DepartmentName + '</option>');
                    }
                    $("#ddlFromdepartment12").html(options.join(''));
                    if (val != "") {
                        $("#ddlFromdepartment12").val(val);
                        LoadDepartmentEmployeesNew(emp)
                    }

                },
                error: function () {
                    alert("error")
                }
            });
        }
        else {
            $("#ddlFromdepartment12").html('<option value="">- Select Department -</option>');
        }

    }


    function LoadDepartmentEmployeesNew(val) {
        if ($("#ddlFromdepartment12").val() != "") {
            $.ajax({
                type: "POST",
                url: "/Common/GetEmployeesByDepartment",
                data: "id=" + $("#ddlFromdepartment12").val(),
                success: function (data) {
                    
                    var options = [];
                    options.push('<option value="">- Select User -</option>');
                    for (var i = 0; i < data.length; i++) {
                        options.push('<option value="' + data[i].CustomUserId + '">' + data[i].FirstName + " " + data[i].LastName + '</option>');
                    }
                    $("#ddlfromEmployee123").html(options.join(''));
                    if(val!="")
                        $("#ddlfromEmployee123").val(val);
                },
                error: function () {
                    alert("error")
                }
            });
        }
        else {
            $("#ddlfromEmployee123").html('<option value="">- Select User -</option>');
        }
    }
    function LoadTransferData() {
        $('#tblUserAssetTransfer').dataTable({
            "bServerSide": true,
            "sAjaxSource": "/Asset/AjaxGetAssetTransferDetails",
            "bProcessing": true,
            "bDestroy": true,
            "aLengthMenu": [[10, 20, 30, 50, 100, 150, 200, -1], [10, 20, 30, 50, 100, 150, 200, "All"]],
            "aoColumns": [
                { "sName": "id" },
                { "sName": "FromLocation" },
                { "sName": "TOLocation" },
                { "sName": "FromDepartment" },
                { "sName": "TODepartment" },
                { "sName": "FromUserId" },
                { "sName": "ToUserId" },
                { "sName": "Date_Assign" },
                { "sName": "ReasonForTransfer" },
                { "sName": "Remarks" },
                {
                    "sName": "UserAssetId",
                    "bSortable": false,
                    "render": function (data) {
                        return '<div class="btn-group">' +
                            '<div class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-th-list"></span></div>' +
                            '<ul class="dropdown-menu dropdown-menu-right">' +
                            '<li><a href="javascript:void(0);" id="' + data + '" onclick="TransferConfirm(this.id);">Confirm</a></li>' +
                            '<li><a href="javascript:void(0);" id="' + data + '" onclick="Edit(this.id);">Edit</a></li>' +

                            '<li><a href="javascript:void(0);"  onclick="Approval(' + data + ')">Approval</a></li>' +
                            '<li><a href="javascript:void(0);"  onclick="Reject(' + data + ')">Reject</a></li>' +
                            //'<li><a href="javascript:void(0);" id="' + data + '" onclick="Documents(this.id);">Document</a></li>' +
                            //'<li><a href="javascript:void(0);" id="' + data + '" onclick="Print(this.id);">Print</a></li>' +
                            //'<li><a href="javascript:void(0);" id="' + data + '" onclick="Delete(this.id);">Delete</a></li>' +
                            '</ul></div>';
                    }
                }
            ]
        });
        $("#tblUserAssetTransfer_length").addClass("col-md-6");
        $("#tblUserAssetTransfer_length").addClass("col-md-6");
    }
    function TransferConfirm(id) {
        eId = id;
        $.get("/Asset/GetAssetTransfers", { id: id }, function (data) {
            
            $("#myModalComfirmUserAsset").modal('show');
            $("#fromLocation").text(data.fromLocation);
            $("#toLocation").text(data.toLocation);
            $("#fromDepartment").text(data.fromdept);
            $("#toDepartment").text(data.toDept);
            $("#requestedUser").text(data.fromUser);
            if (toUser!=null)
            $("#toUser").text(data.toUser);
            $("#asset").text(data.model.AssetName);
            $("#ReasonToTranfer").text(data.model.ReasonToTranfer);

        });
    }

    function Edit(id) {
        eId = id;
        $.get("/Asset/GetAssetTransfers", { id: id }, function (data) {
            
            $("#myModalNewAssetTransfer").modal('show');
            $("#ddllocation1").val(data.model.ToLocationId);
            LoadDepartment123(data.model.ToDepartmentId, data.model.ToUserId);
            $("#txtReasonToTranfer").val(data.model.ReasonToTranfer);
            $("#ddlFromlocation1").val(data.model.CurrentLocationId);
            LoadDepartmentNew(data.model.CurrentDepartmentId, data.model.RequestUserId);
            $("#AssetName").val(data.model.AssetName);

        });
    }
    function OnclickConfirm() {
        $.get("/Asset/ConfirmAssetTransfer", { id: eId, remarks: $("#Remarks").val() }, function (data) {
            $("#myModalComfirmUserAsset").modal('hide');
            alert("Successfully transfered");
            LoadTransferData();
        });
    }
    function OpenNewBrand() {
        
        $("#ddlFromlocation1").val('@ViewBag.Location');
        LoadDepartmentNew('@ViewBag.Department','@ViewBag.EmpNo');
        $("#myModalNewAssetTransfer").modal('show');
    }
    function GetAsset() {
            $.get('/Asset/GetAssetListbyLoginUser', function (data) {
                var options = [];
                options.push('<option value="0">- Select Asset -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].AssetId + '">' + data[i].Name + '</option>');
                }
                // $("#ParentAssetName").html(options.join(''));
                $("#ddlAsset").html(options.join(''));

                //$("#EditParentAssetName").html(options.join(''));
            });
    }
    function validateAssetTransfer() {
       var validate = true;
        $(".css-error").removeClass('css-error');
        //if ($("#EditUserName").val() == 0) {
        //    $("#EditUserName").addClass('css-error');
        //    validate = false;
        //}
        if ($("#AssetName").val() == 0) {
            $("#AssetName").addClass('css-error');
            validate = false;
        }
        if ($("#txtReasonToTranfer").val() == 0) {
            $("#txtReasonToTranfer").addClass('css-error');
            validate = false;
        }
        if ($("#ddllocation1").val() == 0) {
            $("#ddllocation1").addClass('css-error');
            validate = false;
        }
        else if ($("#ddldepartment12").val() == "") {
            $("#ddldepartment12").addClass('css-error');
            validate = false;
        }
        else if ($("#ddlEmployee123").val() == "") {
            $("#ddlEmployee123").addClass('css-error');
            validate = false;
        }
        return validate;
    }
    function OnclickSave() {
        var validate=   validateAssetTransfer();
        if (validate) {
            $(".css-error").removeClass('css-error');

            var task = {
                RequestId:eId,
                ToLocationId: $("#ddllocation1").val(),
                ToDepartmentId: $("#ddldepartment12").val(),
                ToUserId: $("#ddlEmployee123").val(),
                ReasonToTranfer: $("#txtReasonToTranfer").val(),
                CurrentDepartmentId: $("#ddlFromdepartment12").val(),
                CurrentLocationId: $("#ddlFromlocation1").val(),
                RequestUserId: $("#ddlfromEmployee123").val(),
                AssetName: $("#AssetName").val(),
            };
            $.ajax({
                type: "POST",
                url: "/Asset/SaveNewUserAssetTransferAsset",
                data: task,
                success: function (data) {
                    $("#myModalNewAssetTransfer").modal('hide');
                    LoadTransferData();                   
                    alert("added successfully")
                }
            });
        }
        else {
            alert("Fields Required");
        }
    }

    function Approval(id) {
        eId = id;
        type = "Approval";
            $("#headerapprove").html('<b>Approve</b> <button type="button" class="pull-right close" data-dismiss="modal">&times;</button>');
            $('#btnApproveReject').val("Approve");
            $("#myModal").modal("show");

    }
    function Reject(id) {
        eId = id;
        type = "Reject";

            $('#btnApproveReject').val("Reject");
            $("#headerapprove").html('<b>Reject</b> <button type="button" class="pull-right close" data-dismiss="modal">&times;</button>');

            $("#myModal").modal("show");
    }
    function Approval_Reject_Request() {

        if ($("#txtapprovecomments").val() != "") {
            $.get("/Asset/Approval_Reject_AssetTransfer?id=" + eId + "&status=" + type + "&comments=" + $("#txtapprovecomments").val() + "&type=" + $("#RequestType").val(), function (data) {
                $("#myModal").modal("hide");
                window.location.reload();
            });
        }
        else {
            $(".error").hide();
            $(".css-error").removeClass('css-error');
            $("#txtapprovecomments").after('<span class="error" style="color:Red;">Enter comment</span>');
            $("#txtapprovecomments").addClass('css-error');
        }
    }
</script>
<div class="panel panel-default">
    <div class="panel-heading"> Asset Transfer Requests<span style="cursor:pointer;" onclick="OpenNewBrand();" class="pull-right">New Request</span></div>
    <div class="panel-body">

        <table class="table table-striped table-bordered dt-responsive nowrap" style="width:100%;" id="tblUserAssetTransfer">
            <thead>
                <tr style="background-color: #786C67;color: white;">
                    <th>Id</th>
                    <th>From Location</th>
                    <th>To Location</th>
                    <th>From Department</th>
                    <th>To Department</th>
                    <th>From Emp Id</th>
                    <th>To Emp Id</th>
                    <th>Date Assign</th>
                    <th>Reason</th>
                    <th>Remarks</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="myModalComfirmUserAsset" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" onclick="clearAll();">×</button>
                <h4 class="modal-title">Confirm Asset Transfer</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" class="form-control" id="ID">
                <div class="row" style="padding:5px;">
                    <div class="col-md-3"><label for="name">From Location</label></div>
                    <div class="col-md-3">
                        <label id="fromLocation"></label>
                    </div>
                    <div class="col-md-3"><label for="name">To Location</label></div>
                    <div class="col-md-3">
                        <label id="toLocation"></label>
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-3"><label for="name">From Department</label></div>
                    <div class="col-md-3">
                        <label id="fromDepartment"></label>
                    </div>
                    <div class="col-md-3"><label for="name">To Department</label></div>
                    <div class="col-md-3">
                        <label id="toDepartment"></label>
                    </div>
                </div>
                
                <div class="row" style="padding:5px;">
                    <div class="col-md-3"><label for="name">Requested User</label></div>
                    <div class="col-md-3">
                        <label id="requestedUser"></label>
                    </div>
                    <div class="col-md-3"><label for="name">To User</label></div>
                    <div class="col-md-3">
                        <label id="toUser"></label>
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-3"><label for="name">Asset </label></div>
                    <div class="col-md-3">
                        <label id="asset"></label>
                    </div>
                    <div class="col-md-3"><label for="name">Remarks</label></div>
                    <div class="col-md-3">
                        <textarea class="form-control" id="Remarks"></textarea>
                    </div>
                </div>

                <div class="row" style="padding:5px;">
                    <div class="col-md-4"><label for="name">Reason To Tranfer</label></div>
                    <div class="col-md-8">
                        <label id="ReasonToTranfer"></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <input type="button" id="btnasigntask" value="Confirm" onclick="OnclickConfirm();" class="btn btn-primary">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>


<div id="myModalNewAssetTransfer" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" onclick="clearAll();">×</button>
                <h4 class="modal-title">New Asset Transfer</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" class="form-control" id="ID">
                <div class="row" style="padding:5px;">
                    <div class="col-md-6">
                        <label for="name">From Location</label>
                        <select id="ddlFromlocation1" class="form-control" onchange="LoadDepartmentNew('','');">
                            <option value="">Select Location</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="name">From Department</label>
                        <select id="ddlFromdepartment12" class="form-control" onchange="LoadDepartmentEmployeesNew('');">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-6">
                        <label for="name">To Location</label>
                        <select id="ddllocation1" class="form-control" onchange="LoadDepartment123('','');">
                            <option value="">Select Location</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="name">To Department</label>
                        <select id="ddldepartment12" class="form-control" onchange="LoadDepartmentEmployees('');">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-6">
                        <label for="name">Request for Transfer Type</label>
                        <select id="ddlRequestForTransfer" class="form-control">
                            <option value="">Select</option>
                            <option value="By User">By User</option>
                            <option value="By Department">By Department</option>
                        </select>
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-6">
                        <label for="name">Request User</label>
                        <select id="ddlfromEmployee123" class="form-control">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="name">To User</label>
                        <select id="ddlEmployee123" class="form-control">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                </div>


                <div class="row" style="padding:5px;">
                    <div class="col-md-6">
                        <label for="name">Asset Name</label>
                        <input type="text" id="AssetName" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label for="name">Reason To Tranfer</label>
                        <textarea id="txtReasonToTranfer" class="form-control"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <input type="button" id="btnasigntask" value="Confirm" onclick="OnclickSave();" class="btn btn-primary">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<div class="modal fade" id="myModal" role="dialog">
    <div class="form-block">
        <div class="header" style="font:100px; " id="headerapprove">Approve<button type="button" class="pull-right close" data-dismiss="modal">&times;</button></div>
        <form id="AddNewTask" method="post" enctype="multipart/form-data">
            <!-- Grid row -->
            <div class="form-row">
              
                <div class="form-group col-md-12">
                    <label>Comments<span style="color:red;">*</span></label>
                    <textarea id="txtapprovecomments" class="form-control"></textarea>
                </div>
                <div class="form-group col-md-12">
                    <input type="button" id="btnApproveReject" class="btn save header" onclick="Approval_Reject_Request();" />
                    <button type="button" data-dismiss="modal" class="btn cancel">Cancel</button>
                </div>
                <div class="clearfix"></div>
            </div>

            <!-- Grid row -->


        </form>
    </div>
</div>
