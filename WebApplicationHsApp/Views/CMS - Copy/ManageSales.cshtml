@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script>
    var validate = true;
    var eId = 0;
    $(document).ready(function () {
        EmployeeSearch();
        LoadCanteen();
        $("#SFromDate")
            .datepicker({
                changeMonth: true,
                changeYear: true,
                Edit: true,
                dateFormat: "dd/mm/yy",
                //minDate:0,
                yearRange: "-30:+30",
                onSelect: function (dateText, inst) {
                    $("#SToDate").datepicker("option", "minDate",
                        $("#SFromDate").datepicker("getDate"));
                }
            });
        $("#SToDate")
            .datepicker({
                changeMonth: true,
                changeYear: true,
                dateFormat: "dd/mm/yy",
                yearRange: "-30:+30",
                Edit: true,

            });
        //$("#SFromDate").val($.datepicker.formatDate("dd/mm/yy", new Date()));
        //$("#SToDate").val($.datepicker.formatDate("dd/mm/yy", new Date()));
        LoadData();

    });
    function ExportPdf() {
        validateDate();

        if (validate) {
            FromDate = $("#SFromDate").val();
            ToDate = $("#SToDate").val();
            var canteen = $("#SddlCanteen").val() != "" ? $("#SddlCanteen").val() : 0;
            var emp = $("#SddlEmpId").val() != "" ? $("#SddlEmpId").val() : 0;
            window.location = '/CMS/ExportPDFSales?FromDate=' + FromDate + '&ToDate=' + ToDate + '&role=Admin&mode=All&Canteen=' + canteen + '&emp=' + emp;
            //$("#SFromDate").val("");
            //$("#SToDate").val("");
        }
    }
    function ExportExcel() {
        validateDate();

        if (validate) {
            FromDate = $("#SFromDate").val();
            ToDate = $("#SToDate").val();
            window.location = '/CMS/ExportExcelSales?FromDate=' + FromDate + '&ToDate=' + ToDate + '&role=Admin';
            //$("#SFromDate").val("");
            //$("#SToDate").val("");
        }
    }
    function validateDate() {
        debugger;
        validate = true;
        $(".css-error").removeClass('css-error');
        if ($("#SFromDate").val() == "") {
            $("#SFromDate").addClass('css-error');
            validate = false;
        }
        if ($("#SToDate").val() == "") {
            $("#SToDate").addClass('css-error');
            validate = false;
        }
    }
    function LoadData() {
        $('#tblCategory').dataTable({
            "bServerSide": true,
            "sAjaxSource": "/CMS/AjaxGetSales",
            "bProcessing": true,
            "bDestroy": true,
            "aLengthMenu": [[10, 20, 30, 50, 100, 150, 200, -1], [10, 20, 30, 50, 100, 150, 200, "All"]],
            "aoColumns": [
                { "sName": "TransactionId" },
                { "sName": "CreatedOn" },
                { "sName": "CanteenName" },
                { "sName": "SaleType" },
                { "sName": "TotalAmount" },
                { "sName": "DiscountValue" },
                { "sName": "FinalPrice" },
                { "sName": "PaidAmount" },
                { "sName": "EmpName" },
                { "sName": "EmpMobile" },
                { "sName": "EmpId" },
                { "sName": "Name" },
                { "sName": "ModeOfPayment" },
                {
                    "sName": "TransactionId",
                    "bSortable": false,
                    "render": function (data, row, r) {
                        //console.log(r);
                        return '<div class="btn-group">' +
                            '<div class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-th-list"></span></div>' +
                            '<ul class="dropdown-menu dropdown-menu-right">' +
                            '<li><a href="javascript:void(0);" onclick="onEdit(' + data + ')">Edit</a></li>' +
                            '<li><a href="javascript:void(0);" onclick="OnPrint(' + data + ')">Print</a></li>' +
                            '</ul></div>';
                    }
                }
            ],
            "fnServerParams": function (aoData) {
                aoData.push(
                    { "name": "FormType", "value": $("#SddltypeofSelect").val() },
                    { "name": "fromdate", "value": $("#SFromDate").val() },
                    { "name": "ModeOfPayment", "value": $("#SddlModeOdPayment").val() },
                    { "name": "todate", "value": $("#SToDate").val() },
                    { "name": "Canteen", "value": $("#SddlCanteen").val() },
                    { "name": "Emp", "value": $("#SddlEmpId").val() },
                );
            }
        });
        $("#tblCategory_length").addClass("col-md-6");
        $("#tblCategory_length").addClass("col-md-6");
        LoadDataforTotal();
        //validateDate();

        //if (validate) {
        //    LoadDataforTotal();
        //}
        //else {
        //    $('#total').hide();
        //}
    }
    function OnPrint(id) {
        var url = "";
        url = "/CMS/bill?id=" + id;
        window.open(url);
    }
    function LoadDataforTotal() {
        var url = '/CMS/GetTotalAmount?role=Admin';
        var FromDate = $("#SFromDate").val();
        var ToDate = $("#SToDate").val();
        if (FromDate != "") {
            url += '&FromDate=' + FromDate;
        }
        if (ToDate != "") {
            url += '&ToDate=' + ToDate;
        }

        var canteen = $("#SddlCanteen").val() != "" ? $("#SddlCanteen").val() : 0;
        var emp = $("#SddlEmpId").val() != "" ? $("#SddlEmpId").val() : 0;
        url += '&Canteen=' + canteen + '&emp=' + emp;
        $.get(url, function (res) {
            debugger;
            $('#StaffAmountTotal').html(res.StaffAmount);
            $('.totalAmount').html(res.totalAmount);
            $('#Cashamount').html(res.cashAmount);
            $('#CreditAmount').html(res.CreditAmount);
            $('#uPIAmount').html(res.uPIAmount);
            $('#CardAmount').html(res.CardAmount);

            $('#outerAmount').html(res.outerAmount);
            $('#InpatientAmount').html(res.InpatientAmount);
            $('#total').show();

        });

    }
    function EmployeeSearch() {

        $("#SddlEmpId").select2({
            ajax: {
                url: "/Home/GetEmployeeSearch",
                type: "get",
                dataType: 'json',

                //delay: 250,
                data: function (params) {
                    return {
                        searchTerm: params.term // search term
                    };
                },
                processResults: function (response) {
                    return {
                        results: response
                    };
                },
                cache: true
            },
            width: 'element',
            minimumInputLength: 4
        });
    }
    function LoadCanteen() {
        $.ajax({
            type: "POST",
            url: "/CMS/GetStore",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Canteen -</option>');
                for (var i = 0; i < data.length; i++) {
                    if (data[i].TypeOf == "Canteen") {
                        options.push('<option value="' + data[i].StoreId + '">' + data[i].StoreName + '</option>');
                    }
                }
                $("#SddlCanteen").html(options.join(''));
            },
            error: function () {
                alert("error");
            }
        });
    }
    function onEdit(id) {
        EditLoadPartialdivonclick("CancelCaptureSalesByCanteen", "Update Canteen Sales", id);
    }
    function EditLoadPartialdivonclick(link, title, id) {
        $("#titleofpage").html(title);
        $("#partialDiv").load("/CMS/" + link + "?id=" + id);
    }
</script>

<div class="panel panel-default" style="min-height:500px;">
    <div class="panel-heading">Manage Sales</div>
    <div class="panel-body">
        <div class="row">

            <table class="table">
                <tr>
                    <td>
                        <select class="form-control" id="SddlEmpId">
                            <option value=""> Sales Emp Name</option>
                        </select>
                    </td>
                    <td>
                        <select id="SddlCanteen" class="form-control">
                            <option value="">Canteen</option>

                        </select>
                    </td>
                    <td>
                        <select class="form-control" id="SddltypeofSelect">
                            <option value="">All Sales Type</option>
                            <option value="Emp">Staff</option>
                            <option value="Outer">Others</option>
                            <option value="InPatient">In Patient</option>
                        </select>
                    </td>
                    <td>
                        <select id="SddlModeOdPayment" class="form-control">
                            <option value="">All Mode of Payment</option>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                        </select>
                    </td>
                    <td>
                        <input class="form-control Date" autocomplete="off" type="text" placeholder="From Date" id="SFromDate" />
                    </td>
                    <td>
                        <input class="form-control Date" autocomplete="off" type="text" placeholder="To Date" id="SToDate" />
                    </td>
                    <td>
                        @*<a href="#" class="btn btn-success" onclick="ExportExcel();">
                                <i class="fa fa-download"></i>
                            </a>*@
                        <a href="#" class="btn btn-danger" onclick="ExportPdf();">
                            <i class="fa fa-file-pdf-o"></i>
                        </a>
                        <input type="button" class="btn btn-danger" id="btnGo" onclick="LoadData();" value="Go" />
                    </td>
                </tr>
            </table>



        </div>
        <div class="row" id="total">
            <div class="col-md-6">
                <table class="table table-bordered table-striped">
                    <tr>
                        <td class="bg-primary">Total Amount </td>
                        <td class="totalAmount">0</td>
                    </tr>
                    <tr>
                        <td>Cash </td>
                        <td id="Cashamount">0</td>
                    </tr>
                    <tr>
                        <td>Credit </td>
                        <td id="CreditAmount">0</td>
                    </tr>
                    <tr>
                        <td>UPI </td>
                        <td id="uPIAmount">0</td>
                    </tr>
                    <tr>
                        <td>Card </td>
                        <td id="CardAmount">0</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-bordered table-striped">
                    <tr>
                        <td class="bg-primary">Total Amount :</td>
                        <td class="totalAmount">0</td>
                    </tr>
                    <tr>
                        <td>Staff :</td>
                        <td id="StaffAmountTotal">0</td>
                    </tr>
                    <tr>
                        <td>Patient :</td>
                        <td id="InpatientAmount">0</td>
                    </tr>
                    <tr>
                        <td>Other :</td>
                        <td id="outerAmount">0</td>
                    </tr>
                </table>
            </div>
        </div>
        <table class="table table-striped table-bordered dt-responsive nowrap" style="width:100%;" id="tblCategory">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Date</th>
                    <th>Canteen</th>
                    <th>Sale Type</th>
                    <th>Total Amount</th>
                    <th>Discount</th>
                    <th>Final Price</th>
                    <th>Paid Amount</th>
                    <th>Name</th>
                    <th>Mobile</th>
                    <th>Sales EmpId</th>
                    <th>Sales Emp Name</th>
                    <th>Mode Of Payment</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>