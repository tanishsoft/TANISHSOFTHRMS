@{
    ViewBag.Title = "EmployeeLeaves";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    if (ViewBag.UploadImportMsg != null)
    {
        <script>
            OpenSuccessAlertPopUpBox_ConfirmPopUpJS("@ViewBag.UploadImportMsg");
        </script>
    }
}

<script>
    var validate = true;

    $(document).ready(function () {
        Bind();
        LoadLocations1();
        LoadLeaveType();
        $('.txtdate').datepicker({
            changeMonth: true,
            changeYear: true,

            minDate: "0"
        });
    });
    function Bind() {
        //$.ajax({
        //    type: "POST",
        //    url: "/HrAdmin/GetEmployeeLeaves",
        //    //data: "id=" + $("#ddlDepartment1").val(),
        //    success: function (data) {
        //        var html = "";
        //        for (var i = 0; i < data.length; i++) {
        //            html += " <tr><td>" + data[i].UserLeaveId + "</td> <td>" + CheckNull(data[i].LocationName) + "</td> <td>" + CheckNull(data[i].DepartmentName) + "</td> <td>" + CheckNull(data[i].UserName) + "</td> <td>" + CheckNull(data[i].LeaveTypeName) + "</td><td>" + CheckNull(data[i].CountOfLeave) + "</td><td>" + CheckNull(data[i].AvailableLeave) + "</td><td>" + functionDate(data[i].ExpireDate) + "</td><td>" + data[i].IsActive + "</td>";
        //            html += "<td><span id='" + data[i].UserLeaveId + "' onclick='Delete(this.id);' class='btn btn-danger btn-sm glyphicon glyphicon-remove-circle'> </span></td></tr>";
        //        }
        //        $("#tblbodyleavetyeps").html(html);
        //        $('#listLeaveTypes').DataTable();
        //    },
        //    error: function () {
        //        alert("error")
        //    }
        //});

        $('#ApprovedDataTable').dataTable({
            "bServerSide": true,
            "sAjaxSource": "/HrAdmin/AjaxGetEmployeeLeaveCount",
            "bProcessing": true,
            "bDestroy": true,
            "aoColumns": [
                  //{ "sName": "LeaveId" },
                    { "sName": "UserLeaveId" },
                      { "sName": "LocationName" },
                     { "sName": "DepartmentName" },
                            { "sName": "UserName" },
                            { "sName": "LeaveTypeName" },
                            { "sName": "CountOfLeave" },
                            { "sName": "AvailableLeave" },
                            { "sName": "CompoffBalance" },
                            { "sName": "IsActive" },
                            {
                                "sName": "UserLeaveId",
                                "bSortable": false,
                                "render": function (data) {

                                    return '<div class="btn-group">' +
  '<div class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-th-list"></span></div>' +
  '<ul class="dropdown-menu dropdown-menu-right">' +
' <li><a href="#" id="' + data + '" onclick="Editleave(this.id);">Edit</a></li>' +
    ' <li><a href="#" id="' + data + '" onclick="Delete(this.id);">Delete</a></li>' +
  '</ul></div>';
                                }
                            }

            ],
            "aLengthMenu": [[10, 20, 30, 50, 100, 150, 200, 500, 1000], [10, 20, 30, 50, 100, 150, 200, 500, 1000]],
            "sDom": 'T<"clear">lfrtip',
            "oTableTools": {
                "sSwfPath": "/swf/copy_csv_xls_pdf.swf",
                "aButtons": [
                    "copy", "xls", "pdf"
                ]
            },
            "fnServerParams": function (aoData) {
                aoData.push(
                    { "name": "LeaveTypeid", "value": $("#ddlLeaveType").val() },
                    { "name": "fromdate", "value": $("#fromdate").val() },
                    { "name": "todate", "value": $("#todate").val() },
                     { "name": "Emp", "value": $("#ddlEmployees").val() }
                );
            }
        });
        $("#ApprovedDataTable_length").addClass("col-md-6");
        $("#ApprovedDataTable_info").addClass("col-md-6");
    }
    function Delete(id) {
        if (confirm("Are you Sure you want to delete ?")) {
            $.ajax({
                type: "POST",
                url: "/HrAdmin/DeleteEmployeeLeave",
                data: "id=" + id,
                success: function (data) {
                    //alert(data);
                    Bind();
                },
                error: function () {
                    alert("error")
                }
            });
        }
    }
    var currentempid = '';
    function Editleave(id) {
        currentempid = id;
        $.ajax({
            type: "GET",
            url: "/HrAdmin/GetEmployeeLeavesByid",
            data: "empid=" + id,
            success: function (data) {
                if (data != null) {
                    $("#editcasuval").val(data.CasuvalAvailableLeave);
                    $("#editSick").val(data.SickAvailableLeave);
                    $("#editEarned").val(data.EarnedAvailableLeave);
                    $("#myModalUpdateLeaves").modal('show');
                }
            },
            error: function () {
                alert("error")
            }
        });
    }
    function Updateleaves() {
        var task = {
            empid: currentempid,
            casuval: $("#editcasuval").val(),
            sick: $("#editSick").val(),
            earned: $("#editEarned").val()
        };
        $.ajax({
            type: "GET",
            url: "/HrAdmin/UpdateEmployeeleaves",
            data: task,
            success: function (data) {
                $("#myModalUpdateLeaves").modal('hide');
                alert(data);
                Bind();

            },
            error: function () {
                alert("error")
            }
        });
    }
    function Save() {
        Validation();
        if (validate) {
            var task = {
                LocationName: $("#LocationName").val(),
                LocationId: $("#LocationId").val(),
                DepartmentName: $("#DepartmentName").val(),
                DepartmentId: $("#DepartmentId").val(),
                UserName: $("#UserName").val(),
                UserId: $("#UserId").val(),
                LeaveTypeName: $("#LeaveTypeName").val(),
                LeaveTypeId: $("#LeaveTypeId").val(),
                CountOfLeave: $("#CountOfLeave").val(),
                //ExpireDate: $("#ExpireDate").val(),
                AvailableLeave: $("#CurrentYearAddedLeaves").val(),
                IsActive: true
            };
            $.ajax({
                type: "POST",
                url: "/HrAdmin/AddEmployeeLeave",
                data: task,
                success: function (data) {
                    $("#myModalLeaveType").modal('hide');
                    //alert(data);
                    Bind();

                },
                error: function () {
                    alert("error")
                }
            });
        }
        else {
            alert("Fields Required");
        }

    }
    function LoadLeaveType() {
        $.ajax({
            type: "POST",
            url: "/HrAdmin/GetLeaveTypes",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- All -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].LeaveTypeId + '">' + data[i].LeaveName + '</option>');
                }
                $("#ddlLeaveType").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function LoadLocations1() {
        $.ajax({
            type: "POST",
            url: "/Common/GetLocations",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Location -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].LocationId + '">' + data[i].LocationName + '</option>');
                }
                $("#ddlLocation").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function LoadDepartment1() {
        $("#LocationId").val($("#ddlLocation").val());
        var skillsSelect = document.getElementById("ddlLocation");
        var selectedText = skillsSelect.options[skillsSelect.selectedIndex].text;
        $("#LocationName").val(selectedText);
        $.ajax({
            type: "POST",
            url: "/Common/GetDepartmentByLocation",
            data: "id=" + $("#ddlLocation").val(),
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Department -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].DepartmentId + '">' + data[i].DepartmentName + '</option>');
                }
                $("#ddlDepartment").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function LoadEmployees() {
        $("#DepartmentId").val($("#ddlDepartment").val());
        var skillsSelect = document.getElementById("ddlDepartment");
        var selectedText = skillsSelect.options[skillsSelect.selectedIndex].text;
        $("#DepartmentName").val(selectedText);
        $.ajax({
            type: "POST",
            url: "/Common/GetEmployeesByDepartment",
            data: "id=" + $("#ddlDepartment").val(),
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Employee -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].CustomUserId + '">' + data[i].FirstName + " " + data[i].LastName + '</option>');
                }
                $("#ddlEmployee").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function EmployeeChange() {
        $("#UserId").val($("#ddlEmployee").val());
        var skillsSelect = document.getElementById("ddlEmployee");
        var selectedText = skillsSelect.options[skillsSelect.selectedIndex].text;
        $("#UserName").val(selectedText);
    }
    function LeaveTypeChange() {
        $("#LeaveTypeId").val($("#ddlLeaveType").val());
        var skillsSelect = document.getElementById("ddlLeaveType");
        var selectedText = skillsSelect.options[skillsSelect.selectedIndex].text;
        $("#LeaveTypeName").val(selectedText);
    }

    function clearAll() {
        validate = true;
        $(".css-error").removeClass('css-error');
        $("#LocationName").val("");
        $("#LocationId").val("");
        $("#DepartmentName").val("");
        $("#DepartmentId").val("");
        $("#UserName").val("");
        $("#UserId").val("");
        $("#LeaveTypeName").val("");
        $("#LeaveTypeId").val("");
        $("#CountOfLeave").val("");
        $("#ExpireDate").val("");
        $("#ddlLocation").val(" ");
        $("#ddlDepartment").val(" ");
        $("#ddlEmployee").val(" ");
        $("#ddlLeaveType").val(" ");
        $("#CountOfLeave").val("");
        $("#ExpireDate").val("");

    }
    function Validation() {
        validate = true;
        $(".css-error").removeClass('css-error');
        if ($("#ddlLocation").val() == " ") {
            $("#ddlLocation").addClass('css-error');
            validate = false;
        }

        if ($("#ddlDepartment").val() == " ") {
            $("#ddlDepartment").addClass('css-error');
            validate = false;
        }
        if ($("#ddlEmployee").val() == " ") {
            $("#ddlEmployee").addClass('css-error');
            validate = false;
        }
        if ($("#ddlLeaveType").val() == " ") {
            $("#ddlLeaveType").addClass('css-error');
            validate = false;
        }
        if ($("#CountOfLeave").val() == "") {
            $("#CountOfLeave").addClass('css-error');
            validate = false;
        }
        if ($("#ExpireDate").val() == "") {
            $("#ExpireDate").addClass('css-error');
            validate = false;
        }


    }


    function ValidateEmployeeLeaveTypes_ImportExcelFile() {
        var Valid = false;
        if ($("#ExcelFileData").val() != null && $("#ExcelFileData").val() != "") {
            $("#ExcelFileData").removeClass("RedColorBorderCSS");
            Valid = true;
        } else {
            $("#ExcelFileData").addClass("RedColorBorderCSS");
        }
        return Valid;
    }


</script>
<input type="hidden" id="LocationName" />
<input type="hidden" id="LocationId" />
<input type="hidden" id="DepartmentName" />
<input type="hidden" id="DepartmentId" />
<input type="hidden" id="LeaveTypeName" />
<input type="hidden" id="LeaveTypeId" />
<input type="hidden" id="UserName" />
<input type="hidden" id="UserId" />
<div class="panel panel-default">
    <div class="panel-heading">Manage Leave Count  <a href="#" data-toggle="modal" class="pull-right" data-target="#myModalLeaveType">&nbsp;&nbsp;New  Leave Set</a><a href="#" data-toggle="modal" class="pull-right" data-target="#LeaveTypeExcelModal">&nbsp;&nbsp;Import Leave Type</a><a href="/HrAdmin/ExportToExcelEmployeesLeaveTypeData" class="pull-right">&nbsp;&nbsp;Export Excel</a></div>
    <div class="panel-body">
        <table id="ApprovedDataTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%;">
            <thead>
                <tr>
                    <th>Emp Id</th>
                    <th>Location</th>
                    <th>Department</th>
                    <th>Emp Name</th>
                    <th>Casual Leave</th>
                    <th>Sick Leaves</th>
                    <th>Earned Leaves</th>
                    <th>CompOff</th>
                    <th>Is Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="myModalLeaveType" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Employees Set</h4>
            </div>
            <div class="modal-body">
                <div class="row" style="padding:5px;">
                    <div class="col-md-4">
                        <label for="name">Location Name</label>
                    </div>
                    <div class="col-md-8">
                        <select class="form-control" id="ddlLocation" onchange="LoadDepartment1();">
                            <option value="">Select</option>
                        </select>

                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-4"><label for="name">Department Name</label></div>
                    <div class="col-md-8">
                        <select class="form-control" id="ddlDepartment" onchange="LoadEmployees();">
                            <option value="">Select</option>
                        </select>
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-4"><label for="name">Employee</label></div>
                    <div class="col-md-8">
                        <select class="form-control" id="ddlEmployee" onchange="EmployeeChange();">
                            <option value="">Select</option>
                        </select>
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-4"><label for="name">LeaveType Name</label></div>
                    <div class="col-md-8">
                        <select class="form-control" id="ddlLeaveType" onchange="LeaveTypeChange();">
                            <option value="">Select</option>
                        </select>
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-4"><label for="name">Count Of Leave</label></div>
                    <div class="col-md-8">
                        <input type="number" class="form-control" id="CountOfLeave" />
                    </div>
                </div>
                <div class="row" style="padding:5px;">
                    <div class="col-md-4"><label for="name">Current Year Added Leaves</label></div>
                    <div class="col-md-8">
                        <input type="number" class="form-control" id="CurrentYearAddedLeaves" />
                    </div>
                </div>
                @*<div class="row" style="padding:5px;">
                        <div class="col-md-4"><label for="name">Last Leave Update Date</label></div>
                        <div class="col-md-8">
                            <input type="text" class="form-control txtdate" id="ExpireDate" />
                        </div>
                    </div>*@

            </div>
            <div class="modal-footer">
                <input type="button" id="btnasigntask" value="Save" class="btn btn-primary" onclick="Save();" />
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>


<div id="LeaveTypeExcelModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("AddNewEmployeeData_ImportExcel_Latest", "ImportExcelData", FormMethod.Post, new { enctype = "multipart/form-data" }))
            {
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Employees Set</h4>
            </div>
            <div class="modal-body">
                <div class="row" style="padding:5px;">
                    <div class="col-md-4">
                        <label for="name" class="required">Select File</label>
                    </div>
                    <div class="col-md-8">
                        <input type="file" id="ExcelFileData" name="ExcelFileData" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <input type="submit" id="btnuploadLeaveTypeExcel" value="Save" class="btn btn-primary" onclick=" return ValidateEmployeeLeaveTypes_ImportExcelFile();" />
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            }
        </div>

    </div>
</div>

<div id="myModalUpdateLeaves" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Update Leaves</h4>
            </div>
            <div class="modal-body">
                <table class="table">
                    <tr>
                        <td> Casual Laves </td>
                        <td><input type="text" class="form-control" id="editcasuval" style="width:100px;" /> </td>
                    </tr>
                    <tr>
                        <td> Sick Laves </td>
                        <td><input type="text" class="form-control" id="editSick" style="width:100px;" /> </td>
                    </tr>
                    <tr>
                        <td> Earned Laves </td>
                        <td><input type="text" class="form-control" id="editEarned" style="width:100px;" /> </td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="Updateleaves();">Update</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>