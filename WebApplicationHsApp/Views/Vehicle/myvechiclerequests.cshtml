@model WebApplicationHsApp.DataModel.tbl_VehicleRequest

@{
    ViewBag.Title = "myvechiclerequests";
}
<script>
    $(document).ready(function () {
        LoadData();
        $(".date")
            .datepicker({
                changeMonth: true,
                changeYear: true,
                dateFormat: "dd-mm-yy",
                Edit: true

            })
        $('#btnExport').click(function () {
            validateDate();

            if (validate) {
                FromDate = $("#FromDateExcel").val();
                ToDate = $("#ToDateExcel").val();
                window.location = '/Vehicle/ExportExcelVehicleRequest?FromDate=' + FromDate + '&ToDate=' + ToDate;
                $("#FromDateExcel").val("");
                $("#ToDateExcel").val("");
            }
        });
        $('#btnGO').click(function () {
            //$('#tblVehicleRequest').dataTable().draw();
        });
    });
    $.fn.dataTable.ext.search.push(
        function (settings, data, dataIndex) {
            FromDate = $("#FromDateExcel").val();
            ToDate = $("#ToDateExcel").val();
            var Date = data[5] || 0;

            if (
                (ToDate <= Date && Date >= FromDate)) {
                return true;
            }
            return false;
        }
    );
    function validateDate() {
        debugger;
        validate = true;
        $(".css-error").removeClass('css-error');
        if ($("#FromDateExcel").val() == "") {
            $("#FromDateExcel").addClass('css-error');
            validate = false;
        }
        if ($("#ToDateExcel").val() == "") {
            $("#ToDateExcel").addClass('css-error');
            validate = false;
        }
    }
    function LoadData() {
        $('#tblVehicleRequest').dataTable({
            "bServerSide": true,
            "sAjaxSource": "/Vehicle/AjaxGetMyVehicleRequest",
            "bProcessing": true,
            "bDestroy": true,
            "aLengthMenu": [[10, 20, 30, 50, 100, 150, 200, -1], [10, 20, 30, 50, 100, 150, 200, "All"]],
            "aoColumns": [
                { "sName": "UserId" },
                { "sName": "VehicleTypeRequested" },
                { "sName": "FromAddress" },
                { "sName": "ToAddress" },
                { "sName": "Date" },
                {
                    "sName": "ArriveTime",
                     "visible": false
                },
                   { "sName": "Returnr" },
                { "sName": "Returndate" },
                { "sName": "Admin_Status" },
                { "sName": "Status" },
                { "sName": "VehicleDetails" },
                {
                    "sName": "VehicleRequestId",
                    "bSortable": false,
                    "render": function (data) {
                        return '<div class="btn-group">' +
                            '<div class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-th-list"></span></div>' +
                            '<ul class="dropdown-menu dropdown-menu-right">' +
                     
                            '<li><button  id="' + data + '" onclick="ViewHistory(this.id);" class="btn btn-link">Comments&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</button></li>' +
                            '<li><button  id="' + data + '" onclick="ViewDetails(this.id);" class="btn btn-link">View&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</button></li>' +
                            '<li><button id="' + data + '" onclick="Cancel(this.id,this.value);" value="Cancel" class="btn btn-link">Cancel&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</button></li>' +
                            '</ul></div>';
                    }
                }
            ]
        });
        $("#tblVehicleRequest_length").addClass("col-md-6");
//<a href="~/Views/Vehicle/myvechiclerequests.cshtml">~/Views/Vehicle/myvechiclerequests.cshtml</a>
        $("#tblVehicleRequest_length").addClass("col-md-6");
    }

    var currentId = 0;
    function ViewHistory(id) {
        currentId = id;
        $.get("/Vehicle/GetVehicleComments?id=" + id, function (data) {
            var html = "<table class='table'><tr><td>Date</td><td>Comment Type</td><td>Comment</td><td>Comment By</td></tr>";
            for (var i = 0; i < data.length; i++) {
                html += "<tr><td>" + data[i].CommentOn + "</td><td>" + data[i].CommentType + "</td><td>" + data[i].Comment + "</td><td>" + data[i].CommentBy + "</td></tr>";
            };
            html += "</table>";
            $("#ViewAssetHistory").html(html);
            $("#myModalViewDetails").modal('show');
        });
    }
    function ViewDetails(id) {
        currentId = id;
        $.get("/Vehicle/GetRequestVehicleById?RequestId=" + id, function (data) {
            var html = "<table class='table table-bordered'>";
            html += "<tr><td>Pick Up Location</td><td>" + data.FromAddress + "</td><td>Drop Location</td><td>" + data.ToAddress + "</td></tr>";
            html += "<tr><td>Mobile</td><td>" + data.Mobile + "</td><td>Email</td><td>" + data.Email + "</td></tr>";
            html += "<tr><td>Date</td><td>" + data.Date + "</td><td>Status</td><td>" + data.Status + "</td></tr>";
            html += "<tr><td>Start Time</td><td>" + data.StartTime + "</td><td>No of Persons</td><td>" + data.NoofPersons + "</td></tr>";
            html += "<tr><td>Vehicle</td><td>" + data.VehicleDetails + "</td><td>Driver Contact</td><td>" + data.DriverContactDetails + "</td></tr>";
            html += "<tr><td>Remarks</td><td>" + data.Remarks + "</td><td>Vehicle Type</td><td>" + data.VehicleRegisterType + "</td></tr>";
            html += "<tr><td>Vehicle Type Allocated</td><td>" + data.VehicleTypeAllocated + "</td><td>Return Required</td><td>" + data.returnRequired + "</td></tr>";
            html += "<tr><td>Return date</td><td>" + data.Returndate + "</td><td>Return Time</td><td>" + data.Returntime + "</td></tr>";
            html += "</table>";
            $("#divFullViewvehicle").html(html);
            $("#myModalFullViewDetails").modal('show');
        });
    }
    function UpdateComments() {
        $.get("/Vehicle/addComment?id=" + currentId + "&comment=" + $("#txtAssetComments").val(), function (data) {
            alert(data);
            $("#UpdateComments").val("");
            ReloadViewHistory(currentId);
        });
    }
    function ReloadViewHistory(id) {
        $.get("/Vehicle/GetVehicleComments?id=" + id, function (data) {
            var html = "<table class='table'><tr><td>Date</td><td>Comment Type</td><td>Comment</td><td>Comment By</td></tr>";
            for (var i = 0; i < data.length; i++) {
                html += "<tr><td>" + data[i].CommentOn + "</td><td>" + data[i].CommentType + "</td><td>" + data[i].Comment + "</td><td>" + data[i].CommentBy + "</td></tr>";
            };
            html += "</table>";
            $("#ViewAssetHistory").html(html);
        });
    }
    function Cancel(RequestId, val) {
        $.ajax({
            type: "POST",
            url: '/Vehicle/CancelRequestByUser?Id=' + RequestId + '&Status=' + val,
            success: function (data) {
                if (data == true)
                    LoadData();
                else
                    alert("Cancel is not allowed for this request because your request status is updated");
            }
        });

    }
    var RequestUpdate = function (VehicleRequestId) {
        debugger;
        $("#VehicleRequestId").val(VehicleRequestId);
        var Url = "/Vehicle/GetRequestVehicleById?RequestId=" + VehicleRequestId;
        $.ajax({
            type: "GET",
            url: Url,
            success: function (data) {
                $("#myModalRequestUpdate").modal("show");
                var obj = data;
                $("#VehicleRequestId").val(obj.VehicleRequestId);
                $("#VehicleTypeAllocate").val(obj.VehicleTypeAllocated);
                $("#VehicleDetails").val(obj.VehicleDetails);
                if (obj.VehicleRegisterType != null)
                    $("#RegisterType").val(obj.VehicleRegisterType);
                $("#DriverDetails").val(obj.DriverContactDetails);
                if (obj.Status != null)
                    $("#Status").val(obj.Status);
                if (obj.startHour != null)
                    $("#starthour").val(obj.startHour);
                if (obj.startmin != null) $("#startmin").val(obj.startmin);
                if (obj.startam != null) $("#startTime").val(obj.startam);
            }
        })
    }
    function OnclickUpdateRequest() {
        var task = {
            VehicleRequestId: $("#VehicleRequestId").val(),
            VehicleTypeAllocated: $("#VehicleTypeAllocate").val(),
            VehicleDetails: $("#VehicleDetails").val(),
            DriverContactDetails: $("#DriverDetails").val(),
            VehicleRegisterType: $("#RegisterType").val(),
            Status: $("#Status").val(),
            StartTime: $("#starthour").val() + " " + $("#startmin").val() + " " + $("#startTime").val(),
            SendEmail: $('#cbsendemail').prop('checked')
        };
        $.ajax({
            type: "POST",
            url: "/Vehicle/UpdateVehicleRequest",
            data: task,
            success: function (data) {
                //ClearAll();
                $("#myModalRequestUpdate").modal("hide");
            }
        });

    }
    function ClearAll() {
        $("#VehicleRequestId").val("");
        $("#VehicleTypeAllocate").val("");
        $("#VehicleDetails").val("");
        $("#DriverDetails").val("");
        $("#RegisterType").val("-1");
        $("#Status").val("-1");
        $("#starthour").val("00");
        $("#startmin").val("00");
        $("#startTime").val("AM")
    }
</script>
<div id="myModalFullViewDetails" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h4 class="modal-title">View</h4>
            </div>
            <div class="modal-body">
                <div id="divFullViewvehicle">

                </div>
            </div>
        </div>
    </div>
</div>
<div id="myModalViewDetails" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h4 class="modal-title">View</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        Enter Comments
                    </div>
                    <div class="col-md-4">
                        <textarea id="txtAssetComments" class="form-control" autocomplete="off"></textarea>
                    </div>
                    <div class="col-md-4">
                        <input type="button" id="btnpr" class="btn btn-primary" value="Save" onclick="UpdateComments();" />
                    </div>
                </div>
                <div id="ViewAssetHistory">

                </div>
            </div>
        </div>
    </div>
</div>
<div class="panel panel-default">
    <div class="panel-heading">
        My Vehicle Demand
        <input type="button" id="btnExport" value="Export Excel" class="btn btn-link pull-right" />

    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-md-3">

            </div>
            <div class="col-md-6">
                <table style="width:100%;">
                    <tr>
                        <td><label for="name" class="lbl">From Date</label> </td>
                        <td><input class="date form-control" type="text" placeholder="Select Date" id="FromDateExcel" /></td>
                        <td><label for="name" class="lbl">TO Date</label></td>
                        <td><input class="date form-control" type="text" placeholder="Select Date" id="ToDateExcel" /></td>
                        <td><input type="button" id="btnGO" value="GO" class="btn btn-primary" /></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-3">

            </div>

        </div>
        <table class="table table-striped table-bordered dt-responsive nowrap" style="width:100%;" id="tblVehicleRequest">
            <thead>
                <tr>
                    <th>Request ID</th>
                    <th>Type of Vehicle</th>
                    <th>Pickup location</th>
                    <th>Drop location</th>
                    <th>Report Date and Time</th>
                    <th>Arrive Time</th>
                    <th>Return Required</th>
                    <th>Return date and time</th>
                    <th>Admin Status</th>
                    <th>Status</th>
                    <th>Vehicle Details</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="myModalRequestUpdate" class="modal fade" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h4 class="modal-title text-info"><b>Update</b></h4>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" class="form-control" id="VehicleRequestId">
                    <div class="row" style="padding:5px;">
                        <div class="col-md-4">
                            <label for="name">Vehicle Type Allocate</label>

                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="VehicleTypeAllocate">
                        </div>
                    </div>

                    <div class="row" style="padding:5px;">
                        <div class="col-md-4"><label for="name">Vehicle Details</label></div>
                        <div class="col-md-8">
                            <textarea class="form-control" id="VehicleDetails"></textarea>
                        </div>
                    </div>
                    <div class="row" style="padding:5px;">
                        <div class="col-md-4"><label for="name">Driver Details</label></div>
                        <div class="col-md-8">
                            <textarea class="form-control" id="DriverDetails"></textarea>
                        </div>
                    </div>
                    <div class="row" style="padding:5px;">
                        <div class="col-md-4"><label for="name">Register Type</label></div>
                        <div class="col-md-8">
                            <select class="form-control" id="RegisterType">
                                <option value="-1">select Register Type</option>
                                <option value="IN HOUSE">IN HOUSE</option>
                                <option value="OUT SIDE">OUT SIDE</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" style="padding:5px;">
                        <div class="col-md-4"><label for="name">Status</label></div>
                        <div class="col-md-8">
                            <select class="form-control" id="Status">
                                <option value="-1">select Status </option>
                                <option value="IN PROGRESS">IN PROGRESS</option>
                                <option value="ALLOCATED">ALLOCATED</option>
                                <option value="VEHICLE NOT AVAILABLE">VEHICLE NOT AVAILABLE</option>
                                <option value="REJECTED">REJECTED</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" style="padding:5px;">
                        <div class="col-md-4">
                            <label for="name">Start Time</label>

                        </div>
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-sm-3">
                                    <div class="form-group">

                                        <span class="form-label">Hour</span>
                                        <select class="form-control" id="starthour">
                                            <option value="00">00</option>
                                            <option value="01">01</option>
                                            <option value="02">02</option>
                                            <option value="03">03</option>
                                            <option value="04">04</option>
                                            <option value="05">05</option>
                                            <option value="06">06</option>
                                            <option value="07">07</option>
                                            <option value="08">08</option>
                                            <option value="09">09</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                        </select>
                                        <span class="select-arrow"></span>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <span class="form-label">Min</span>
                                        <select class="form-control" id="startmin">
                                            <option value="00">00</option>
                                            <option value="05">05</option>
                                            <option value="10">10</option>
                                            <option value="15">15</option>
                                            <option value="20">20</option>
                                            <option value="25">25</option>
                                            <option value="30">30</option>
                                            <option value="35">35</option>
                                            <option value="40">40</option>
                                            <option value="45">45</option>
                                            <option value="50">50</option>
                                            <option value="55">55</option>
                                        </select>
                                        <span class="select-arrow"></span>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <span class="form-label">AM/PM</span>
                                        <select class="form-control" id="startTime">
                                            <option value="AM">AM</option>
                                            <option value="PM">PM</option>
                                        </select>
                                        <span class="select-arrow"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="padding:5px;">
                        <div class="col-md-12"><input type="checkbox" id="cbsendemail" />SEND EMAIL</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <input type="button" id="btnasigntask" value="Update" onclick="OnclickUpdateRequest();" class="btn btn-primary">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>

