
@{
    ViewBag.Title = "ManageTaskSLAUsers";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script>
    $(document).ready(function () {
        LoadLocations();
        LoadData();
        $("#selUser").select2({
            ajax: {
                url: "/Chat/GetEmployeeSearch",
                type: "get",
                dataType: 'json',
                data: function (params) {
                    return {
                        searchTerm: params.term // search term
                    };
                },
                processResults: function (response) {
                    return {
                        results: response
                    };
                },
                cache: true
            },
            minimumInputLength: 2
        });
    });
    function LoadLocations() {
        $.ajax({
            type: "GET",
            url: "/Common/GetLocations",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].LocationId + '">' + data[i].LocationName + '</option>');
                }
                $("#ddlLocation").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function LoadDepartment() {
        if ($("#ddlLocation").val() != null && $("#ddlLocation").val() != "") {
            $.ajax({
                type: "GET",
                url: "/CallCenter/GetDepartmentByLocation",
                data: "id=" + $("#ddlLocation").val(),
                success: function (data) {
                    var options = [];
                    options.push('<option value="">- Select Department -</option>');
                    for (var i = 0; i < data.length; i++) {
                        //if (data[i].ShowInHelpDesk) {
                        options.push('<option value="' + data[i].DepartmentId + '">' + data[i].DepartmentName + '</option>');
                        //}
                    }
                    $("#ddlDepartment").html(options.join(''));
                },
                error: function () {
                    alert("error")
                }
            });
        }
    }
    function SaveTaskSLAMaster() {
        if ($("#ddlLocation").val() != null && $("#ddlLocation").val() != "" &&
            $("#ddlDepartment").val() != null && $("#ddlDepartment").val() != "" &&
            $("#selUser").val() != null && $("#selUser").val() != "") {
            var task = {
                TaskSLAUserId: 0,
                TaskLocationId: $("#ddlLocation").val(),
                TaskDepartmentId: $("#ddlDepartment").val(),
                SLAUserId: $("#selUser").val(),
                TaskLevel: $("#ddlSlaLevel").val(),
                Description: $("#Description").val(),
                DurationInMinutes: $("#DurationInMinutes").val(),
                EmpMobile: $("#EmpMobile").val(),
                EmpEmail: $("#EmpEmail").val(),
                TypeOfRequest: $("#ddlTypeOfRequest").val()
            };
            $.ajax({
                type: "POST",
                url: "/CallCenter/SaveTaskSLAUser",
                data: task,
                success: function (data) {
                    alert(data);
                    $("#myModal").modal('hide');
                    window.location.reload();
                }
            });
        } else {
            alert("Please enter all the required fields");
        }
    }
    function DeleteTaskSLA(id) {
        if (confirm("Are you sure you want to delete?")) {
            $.get("/CallCenter/DeleteTaskSLAUser?id=" + id, function (data) {
                alert(data);
                LoadData();
            });
        }
    }
    function LoadData() {
        var oTable = $('#myDataTable').dataTable({
            "bServerSide": true,
            "sAjaxSource": "/CallCenter/AjaxGetTaskSLAUsers",
            "bProcessing": true,
            "bDestroy": true,
            "aoColumns": [
                { "sName": "TaskSLAUserId" },
                { "sName": "TaskLocationName" },
                { "sName": "TaskDepartmentName" },
                //{ "sName": "DepartmentEmail" },
                { "sName": "SLAUserId" },
                { "sName": "SLAUserName" },
                { "sName": "SLAUserEmail" },
                { "sName": "SLAUserMobile" },
                { "sName": "TypeOfRequest" },
                { "sName": "TaskLevel" },
                { "sName": "DurationInMinutes" },
                //{ "sName": "Description" },
                {
                    "sName": "TaskSLAUserId",
                    "bSortable": false,
                    "render": function (data) {
                        return "<span id='" + data + "' style='cursor:pointer;color:orange;' onclick='DeleteTaskSLA(this.id)'>Delete</span>";
                    }
                }
            ],
            "aLengthMenu": [[10, 20, 30, 50, 100, 150, 200, 500, 1000], [10, 20, 30, 50, 100, 150, 200, 500, 1000]]
        });
    }
    function CheckDepartmentNameExists() {
        $.get("/CallCenter/GetDepartmentName?locationid=" + $("#ddlLocation").val() + "&departmentid=" + $("#ddlDepartment").val(), function (data) {
            if (data != null && data != "") {
                $("#CustomDepartmentName").val(data);
                $("#CustomDepartmentName").prop("disabled", true);
            } else {
                $("#CustomDepartmentName").prop("disabled", false);
            }
        });
    }
    function ddlSlaLevelchange() {
        if ($("#ddlSlaLevel").val() != "") {
            if ($("#ddlSlaLevel").val() == "1") {
                $("#DurationInMinutes").val(0).prop("disabled", "disabled");
            } else {
                $("#DurationInMinutes").val(30);
                $("#DurationInMinutes").removeProp("disabled");
            }
        } else {
            $("#DurationInMinutes").removeProp("disabled");
            $("#DurationInMinutes").val(0);
        }
    }
</script>
<style>
    .select2-container {
        width: 100% !important;
    }
</style>
<div class="modal fade" id="myModal" role="dialog">
    <div class="form-block" style="width:60%;">
        <h3 style="margin-bottom:10px !important;">New  <button type="button" class="pull-right close" data-dismiss="modal">&times;</button></h3>
        <form id="AddNewTask" method="post" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label>Select Employee<span style="color:red;">*</span></label>
                    <select id="selUser" class="form-control typeahead border-primary" name="query" data-provide="typeahead" autocomplete="off"></select>
                </div>
                <div class="form-group col-md-6">
                    <label>Assign Location<span style="color:red;">*</span></label>
                    <select id="ddlLocation" class="form-control" onchange="LoadDepartment();">
                        <option value="">Select</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label>Assign Department<span style="color:red;">*</span></label>
                    <select id="ddlDepartment" class="form-control" rel="8" style="" onchange="CheckDepartmentNameExists();">
                        <option value="">Select</option>
                    </select>
                </div>

                <div class="form-group col-md-4">
                    <label>Emp Email</label>
                    <input type="text" name="name" id="EmpEmail" rel="15" class="form-control" />
                </div>
                <div class="form-group col-md-4">
                    <label>Emp Mobile</label>
                    <input type="text" name="name" id="EmpMobile" rel="15" class="form-control" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label>SLA Level<span style="color:red;">*</span></label>
                    <select id="ddlSlaLevel" class="form-control" rel="8" onchange="ddlSlaLevelchange();">
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label>Duration In Minutes<span style="color:red;">*</span></label>
                    <select id="DurationInMinutes" class="form-control">
                        <option value="0">0</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                        <option value="60">1 hour</option>
                        <option value="90">90</option>
                        <option value="120">2 hours</option>
                        <option value="150">150</option>
                        <option value="180">3 hours</option>
                        <option value="210">210</option>
                        <option value="240">4 hours</option>
                        <option value="270">270</option>
                        <option value="300">5 hours</option>
                        <option value="360">6 hours</option>
                        <option value="420">7 hours</option>
                        <option value="600">10 hours</option>
                        <option value="900">15 hours</option>
                        <option value="1200">20 hours</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label>Type Of Request<span style="color:red;">*</span></label>
                    <select id="ddlTypeOfRequest" class="form-control">
                        <option value="Requests">Requests</option>
                        <option value="Complaints">Complaints</option>
                    </select>
                </div>
                <div class="form-group col-md-12">
                    <label>Description</label>
                    <textarea id="Description" rows="1" rel="7" class="form-control"></textarea>
                </div>
                <div class="form-group col-md-12">
                    <button type="button" class="btn save" onclick="SaveTaskSLAMaster();">SAVE</button>
                    <button type="button" data-dismiss="modal" class="btn cancel">Cancel</button>
                </div>
                <div class="clearfix"></div>
            </div>
        </form>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <span class="glyphicon glyphicon-tasks" style="vertical-align:middle;color:darkcyan;"></span>&nbsp;Manage Task SLA Users
        <span class="pull-right" style="color:green;font-weight:bold;cursor:pointer;" data-toggle="modal" data-target="#myModal"><span style="vertical-align:middle;" class="glyphicon glyphicon-plus-sign"></span>&nbsp;New</span>
    </div>
    <div class="panel-body" style="padding:4px;">
        <table id="myDataTable" class="table table-striped table-bordered  dt-responsive table-hover dataTables_wrapper" style="width:100%;">
            <thead>
                <tr style="background-color: #786C67;color: white;">
                    <th>Id</th>
                    <th>Location </th>
                    <th>Department</th>
                    @*<th>Dept Email</th>*@
                    <th>User Id</th>
                    <th>User Name</th>
                    <th>User Email</th>
                    <th>User Mobile</th>
                    <th>Type</th>
                    <th>Task Level</th>
                    <th>Duration</th>
                    @*<th>Description</th>*@
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
