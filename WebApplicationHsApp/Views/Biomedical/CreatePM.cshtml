
@{
    ViewBag.Title = "CreatePM";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .maxwidth {
        max-width: 100%;
    }
</style>
<script>
    var eId =@ViewBag.id;
    var datacheck;
    $(document).ready(function () {
        BindMonths();
        EmployeeSearch();
        $(".error1").hide();
        AssertSearch();
        LoadLocations();
        LoadData(eId);
    });
    function AssertSearch() {
        //$("#AssetNumber").select2({

        //    ajax: {
        //        url: "/Biomedical/GetAssertAutoComplete",
        //        type: "get",
        //        dataType: 'json',
        //        //delay: 250,
        //        data: function (params) {
        //            return {
        //                searchTerm: params.term,
        //                id: $("#EquipmentName").val() // search term
        //            };
        //        },
        //        processResults: function (response) {
        //            return {
        //                results: response
        //            };
        //        },
        //        cache: true
        //    },
        //    minimumInputLength: 2
        //});
        $("#EquipmentName").select2({
            ajax: {
                url: "/Biomedical/GetEquipmentNameAutoComplete",
                type: "get",
                dataType: 'json',
                //delay: 250,
                data: function (params) {
                    return {
                        searchTerm: params.term,
                        id: $("#AssetNumber").val()// search term
                    };
                },
                processResults: function (response) {
                    return {
                        results: response
                    };
                },
                cache: true
            },
            minimumInputLength: 2
        });
    }
    function LoadLocations() {
        $.ajax({
            type: "POST",
            url: "/Common/GetLocations",
            //data: "id=",
            success: function (data) {
                var options = [];
                options.push('<option value="">- Select Location -</option>');
                for (var i = 0; i < data.length; i++) {
                    options.push('<option value="' + data[i].LocationId + '">' + data[i].LocationName + '</option>');
                }
                $("#LocationId").html(options.join(''));
            },
            error: function () {
                alert("error")
            }
        });
    }
    function LoadDepartment(val, subval) {
        var options = [];
        options.push('<option value="">- Select Department -</option>');
        if ($("#LocationId").val() != "") {
            $.ajax({
                type: "POST",
                url: "/Common/GetDepartmentByLocation",
                data: "id=" + $("#LocationId").val(),
                success: function (data) {

                    for (var i = 0; i < data.length; i++) {
                        options.push('<option value="' + data[i].DepartmentId + '">' + data[i].DepartmentName + '</option>');
                    }
                    $("#DepartmentId").html(options.join(''));
                    if (val != "") {
                        $("#DepartmentId").val(val);
                        if (subval != "")
                            DepartmentChange(subval);
                    }
                },
                error: function () {
                    alert("error")
                }
            });


        }
        else {
            $("#DepartmentId").html(options.join(''));
        }

    }
    function Cancel() {
        window.location.href = "/Biomedical/ManageDailyRounds";
    }
    function DepartmentChange(val) {
        var options = [];
        options.push('<option value="">- Select sub Department -</option>');
        if ($("#DepartmentId").val() != "") {
            $.ajax({
                type: "POST",
                url: "/Common/GetSubDepartmentByDepartment",
                data: "id=" + $("#DepartmentId").val(),
                success: function (data) {

                    for (var i = 0; i < data.length; i++) {
                        options.push('<option value="' + data[i].SubDepartmentId + '">' + data[i].Name + '</option>');
                    }
                    $("#SubDepartmentId").html(options.join(''));
                    $("#SubDepartmentId").val(val);
                    if (val != null && val != "") {
                        LoadAssetId(datacheck.AssetNumber);
                    }
                },
                error: function () {
                    alert("error")
                }
            });
        }
        else {
            $("#SubDepartmentId").html(options.join(''));
        }

    }
    function EmployeeSearch() {

        $(".EmpId").select2({
            ajax: {
                url: "/Home/GetEmployeeSearch",
                type: "get",
                dataType: 'json',

                //delay: 250,
                data: function (params) {
                    return {
                        searchTerm: params.term // search term
                    };
                },
                processResults: function (response) {
                    return {
                        results: response
                    };
                },
                cache: true
            },
            width: 'element',
            minimumInputLength: 4
        });
    }
    function BindMonths() {
        var date = new Date();
        date.setMonth(date.getMonth());
        var months = 12;
        var monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        var select = document.getElementById('Month');
        var html = '';
        for (var i = 0; i < months; i++) {
            var m = date.getMonth();
            html += '<option value="' + monthNames[m]  + '">' + monthNames[m] + '</option>'
            date.setMonth(date.getMonth() + 1);
        }
        select.innerHTML = html;
    }
    function GetFullMonthbyShortMonth(month) {
        var fullmonth = "";
        switch (month) {
            case "Jan":
                fullmonth = "January";
                break;
            case "Feb":
                fullmonth = "February";
                break;
            case "Mar":
                fullmonth = "March";
                break;
            case "Aprl":
                fullmonth = "April";
                break;
            case "May":
                fullmonth = "May";
                break;
            case "Jun":
                fullmonth = "June";
                break;
            case "Jul":
                fullmonth = "July";
                break;
            case "Aug":
                fullmonth = "August";
                break;
            case "Sept":
                fullmonth = "September";
                break;
            case "Oct":
                fullmonth = "October";
                break;
            case "Nov":
                fullmonth = "November";
                break;
            case "Dec":
                fullmonth = "December";
                break;
        }
        return fullmonth;
    }
    function LoadAssetId(val) {
        if ($("#EquipmentName").val() != null && $("#EquipmentName").val() != "" && $("#DepartmentId").val() != null && $("#DepartmentId").val() != "") {
            $.ajax({
                type: "POST",
                url: "/Biomedical/GetAssertAutoComplete?id=" + $("#EquipmentName").val() + "&locationId=" + $("#LocationId").val() + "&departmentId=" + $("#DepartmentId").val() + "&subDepartmentId=" + $("#SubDepartmentId").val(),
                //data: "id=",
                success: function (data) {
                    var options = [];
                    options.push('<option value="">- Select Asset -</option>');
                    for (var i = 0; i < data.length; i++) {
                        options.push('<option value="' + data[i].id + '">' + data[i].text + '</option>');
                    }
                    $("#AssetNumber").html(options.join(''));
                    if (val != "") {
                        $("#AssetNumber").val(val);
                    }
                },
                error: function () {
                    alert("error")
                }
            });
        }
        else {
            $("#AssetNumber").html('<option value="">- Select Asset -</option>');
        }
    }
    function LoadData(id) {
        if (id != 0) {
            $.get("/Biomedical/GetPm", { id: id }, function (data) {
                datacheck = data;
                $("#LocationId").val(data.LocationId);
                LoadDepartment(data.DepartmentId, data.SubDepartmentId);
                //$("#DepartmentId").val(data.DepartmentId);
                $("#SubDepartmentId").val(data.SubDepartmentId);
                $("#Month").val(GetFullMonthbyShortMonth(data.Month));
                $("#EquipmentName").select2("trigger", "select", { data: { id: data.Equipment, text: data.Equipment } });
                $("#AssignTo").select2("trigger", "select", { data: { id: data.AssignTo, text: data.AssignToName } });
                //LoadAssetId(data.AssetNumber);

            });
        }
    }
    function SaveDetails() {

        var validate= validateinput();
        if (validate) {

            if (window.FormData !== undefined) {

                var files = "";
                // Create FormData object
                var fileData = new FormData();
                fileData.append('PreventiveMaintenanceId', eId);
                fileData.append('LocationId', $("#LocationId").val());

                fileData.append('DepartmentId', $("#DepartmentId").val());
                fileData.append('SubDepartmentId', $("#SubDepartmentId").val());
                fileData.append('Month', $("#Month").val());
                fileData.append('AssetNumber', $("#AssetNumber").val());
                fileData.append('Equipment', $("#EquipmentName").val());
                fileData.append('AssignTo', $("#AssignTo").val());

                fileData.append('type', "New");
                $.ajax({
                    type: "POST",
                    url: "/Biomedical/Save_Update_PM",
                    contentType: false,
                    processData: false,
                    data: fileData,
                    success: function (data) {
                        alert("Success");
                        window.location.href="/Biomedical/ManagePM";
                    }
                });
            } else {
                alert("FormData is not supported.");
            }
        }
    }
    function Cancel() {
        window.location.href="/Biomedical/ManagePM";
    }
    function validateinput() {
        setTimeout(function () { $('.error1').fadeOut('fast'); }, 5000);
      var  validate = true;
        $(".error").hide();
        $(".error1").hide();
        $(".css-error").removeClass('css-error');
        if ($("#LocationId").val() == "") {
            $("#LocationId").after('<span class="error" style="color:Red;">Select Location</span>');
            $("#LocationId").addClass('css-error');
            validate = false;
        }
       else if ($("#DepartmentId").val() == "") {
            $("#DepartmentId").after('<span class="error" style="color:Red;">Select Department</span>');
            $("#DepartmentId").addClass('css-error');
            validate = false;
        }
      //else  if ($("#SubDepartmentId").val() == "") {
      //      $("#SubDepartmentId").after('<span class="error" style="color:Red;">Select Sub Department</span>');
      //      $("#SubDepartmentId").addClass('css-error');
      //      validate = false;
      //  }

        if ($("#AssetNumber").val() == "") {
            $("#AssetNumber").after('<span class="error" style="color:Red;">Enter Asset Number</span>');
            $("#AssetNumber").addClass('css-error');
            validate = false;
        }
        if ($("#EquipmentName").val() == "") {
            $("#EquipmentName").after('<span class="error" style="color:Red;">Enter Equipment</span>');
            $("#EquipmentName").addClass('css-error');
            validate = false;
        }
        if ($('#AssignTo').val() == null) {
            $('.error1').show();
            $('.error1').text("Select Assign Engineer");

            valid = false;
        }

        return validate;
    }
</script>
<div class="container">
    <div class="panel panel-default">
        <div class="panel-heading">&nbsp;Create Preventive Maintenance</div>
        <div class="panel-body">
            <div class="alert alert-danger error1" role="alert">

            </div>
            <div class="row" style="padding:20px;">
                <div class="col-md-6">
                    <label>Assign Location<span style="color:red;">*</span></label>
                    <select class="form-control maxwidth" id="LocationId" onchange="LoadDepartment('','');"></select>
                </div>
                @*<div class="col-md-4">
                        <label>Category of Services<span style="color:red;">*</span></label>
                        <select class="form-control maxwidth" id="Services" onchange="DepartmentChange();">
                            <option value="">- Select Services -</option>
                        </select>
                    </div>*@
                <div class="col-md-6">
                    <label>Assign Department<span style="color:red;">*</span></label>
                    <select class="form-control maxwidth" id="DepartmentId" onchange="DepartmentChange();">
                        <option value="">- Select Department -</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>Sub Department<span style="color:red;">*</span></label>
                    <select class="form-control maxwidth" id="SubDepartmentId">
                        <option value="">- Select Sub Department -</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>Choose Month<span style="color:red;">*</span></label>
                    <select class="form-control maxwidth" id="Month">
                        <option value="">- Select Month -</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>Equipment Name<span style="color:red;">*</span></label>
                    <select id="EquipmentName" class="form-control" style="width:100%;" name="query" data-provide="typeahead" autocomplete="off" onchange="LoadAssetId('');"></select>
                </div>
                <div class="col-md-6">
                    <label>Asset Number<span style="color:red;">*</span></label>
                    <select id="AssetNumber" class="form-control maxwidth"><option value="">- Select Asset -</option></select>
                </div>
                <div class="col-md-6">
                    <label>Assigned Engineer<span style="color:red;">*</span></label>
                    <select id="AssignTo" style="width: 120%" class="form-control typeahead EmpId maxwidth" name="query" data-provide="typeahead" autocomplete="off"></select>
                </div>
            </div>

        </div>


        <div class="row" style="padding:10px;">
            <input type="button" class="btn cancel" value="Cancel" onclick="Cancel();" />
            <input type="button" class="btn save" value="Save" onclick="SaveDetails();" />

        </div>
    </div>
</div>

