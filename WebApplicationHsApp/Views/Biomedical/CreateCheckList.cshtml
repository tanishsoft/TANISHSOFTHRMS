
@{
    ViewBag.Title = "CreateCheckList";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script>
    var eId = @ViewBag.id;
    var tbaleRowCount = 1;
    $(document).ready(function () {
        $('#ItemTable').show();
        LoadItems();
        if (eId != 0) {
            LoadData(eId);
        }
        else {
            AddItem();
        }
    });
    function LoadData(id) {
        $.get("/BioMedical/GetCheckListAndItems?id=" + id, function (res) {
            debugger;
            $("#CheckListName").val(res.checkList.CheckListName);
            $("#Description").val(res.checkList.Description);
            $("#header").text("Update Check List");
            var table = document.getElementById("ItemTable");
            for (var i = 0; i < res.checkListItems.length; i++) {

                AddItem(res.checkListItems[i].ItemId);
                $("#SubName" + (i + 1)).val(res.checkListItems[i].SubName);
                $(".Id" + (i + 1)).text(res.checkListItems[i].Id);

                $("#CheckListType" + (i + 1)).val(res.checkListItems[i].CheckListType);
            }
        });
    }
    function validatedetails(){
        var valid = true;
        $(".error").hide();
        $(".css-error").removeClass('css-error');
        if (!inputvalidation('CheckListName', 'Enter CheckListName')) valid = false;
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length);
        for (var i = 1; i < tbaleRowCount; i++) {
            var mt = $("#ItemId" + i).val();
            if ($("#CheckListType" + i).val() == "") {
                $("#CheckListType" + i).after('<span class="error" style="color:Red;">select Type</span>');
                $("#CheckListType" + i).addClass('css-error');
                valid = false;
            }
            if ($("#SubName" + i).val() == "") {
                $("#SubName" + i).after('<span class="error" style="color:Red;">Enter Name </span>');
                $("#SubName" + i).addClass('css-error');
                valid = false;
            }
        }
        return valid;
    }
    function SaveDetails() {
        var valid = validatedetails();
        if (valid) {
            if (window.FormData !== undefined) {
                var files = "";
                var url = "/BioMedical/Save_UpdateCheckList";//Save and Update
                // Create FormData object
                var fileData = new FormData();
              
                fileData.append('PreventiveCheckListId', eId);
                fileData.append('CheckListName', $("#CheckListName").val());
                fileData.append('Description', $("#Description").val());
             
                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: false,
                    processData: false,
                    data: fileData,
                    success: function (data) {

                        SaveItem(data);
                        alert("Successfully Saved");
                    },
                    error: function (err) {
                        alert(err.statusText);
                    }
                });
            } else {
                alert("FormData is not supported.");
            }
        }
    }
    function SaveItem(id) {
        var ItemList = [];
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length);
        for (var i = 1; i < tbaleRowCount; i++) {
            var row = $('#row' + i).html();
            if (typeof (row) !== 'undefined') {
                ItemList.push({

                    Id: parseInt($(".Id" + i).text()),
                    PreventiveCheckListId: parseInt(id),
                    SubName: $("#SubName" + i).val(),
                    CheckListType: $("#CheckListType" + i).val()
                });
            }

        }

        $.post("/BioMedical/Save_UpdateCheckListItems", { model: ItemList}, function (res) {
            window.location.href = '/BioMedical/ManageCheckList';
        });
    }
    function inputvalidation(selector, Text) {

        var validate = true;
        if ($("#" + selector).val() == "") {
            $("#" + selector).after('<span class="error" style="color:Red;">' + Text + '</span>');
            $("#" + selector).addClass('css-error');
            validate = false;
        }
        return validate;
    }
    function cancel() {
        window.location.href = '/BioMedical/ManageCheckList';
    }
    function LoadItems(id, val) {
                var options = [];
                options.push('<option value="">- Select Type -</option><option value="Visual Check">Visual Check</option><option value="Functional Check">Functional Check</option>');
                $("#CheckListType" + id).html(options.join(''));
                if (val != "")
                    $("#CheckListType" + id).val(val);
    }
    function AddItem(val) {
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length);
        if (table_len > 1) {
            if (eId == 0) {
                var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tbaleRowCount + "'><td class='Id" + tbaleRowCount + "' style='display:none;'>0</td><td> <select id='CheckListType" + tbaleRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Type</option></select></td><td>  <input type='text' class='form-control' id='SubName" + tbaleRowCount + "'></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tbaleRowCount + ")'></span></td></tr>";
            }
            else {
                var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tbaleRowCount + "'><td class='Id" + tbaleRowCount + "' style='display:none;'>0</td><td> <select id='CheckListType" + tbaleRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Type</option></select></td><td>  <input type='text' class='form-control' id='SubName" + tbaleRowCount + "'></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tbaleRowCount + ")'></span></td></tr>";
             
            }
        }
        else {
            var row = table.insertRow(table_len).outerHTML = "<tr class='datarow' id='row" + tbaleRowCount + "'><td class='Id" + tbaleRowCount + "' style='display:none;'>0</td><td> <select id='CheckListType" + tbaleRowCount + "' class='form-control' style='max-width:200px;'> <option value=''>Select Type</option></select></td><td>  <input type='text' class='form-control' id='SubName" + tbaleRowCount + "'></td><td> <span class='glyphicon glyphicon-trash' style='color:red;cursor:pointer;' onclick='delete_row(" + tbaleRowCount + ")'></span></td></tr>";
        }
        LoadItems(tbaleRowCount, val);
        tbaleRowCount++;
        $('#ItemTable').show();
        }


    function delete_row(no) {
        document.getElementById("row" + no + "").outerHTML = "";
        var table = document.getElementById("ItemTable");

        var table_len = (table.rows.length - 1);
        if (table_len == 0) {
            $('#ItemTable').hide();
        }
    }

</script>
<div class="panel panel-default">
    <div class="panel-heading">Create Check List</div>
    <div class="panel-body">
        <div class="row" style="width:95%;margin:auto;">

            <div class="col-md-12">
                <table class="table table-stribbed">
                    <tr>
                        <td>
                            <label>Check List Name<span class="text-danger">*</span> </label>
                        </td>
                        <td>
                            <input type="text" name="CheckListName" id="CheckListName" class="form-control maxwidth" />
                        </td>
                        <td>&nbsp;</td>
                        <td>
                            <label>Description</label>
                        </td>
                        <td>

                            <textarea class="form-control maxwidth" id="Description"></textarea>
                        </td>

                    </tr>
                </table>
                <table id="ItemTable" class="table table-borderedtable-condensed table-striped">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Action <a href="javascript:void(0)" class="pull-right" style="color:green;font-size:14px;" onclick="AddItem();"><span class="glyphicon glyphicon-plus"></span></a></th>
                        </tr>
                    </thead>
                </table>
            </div>
            <br />
            <div class="form-group col-md-6">
                <br />
                <button type="button" class="btn save" onclick="SaveDetails();">Save</button>
                <button type="button" onclick="cancel();" class="btn cancel">Cancel</button>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>
